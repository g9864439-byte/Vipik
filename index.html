<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VapeHub | @ZHIZHA_BOSS | Mini-App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* МИНИМАЛИСТИЧНЫЙ ДИЗАЙН */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html {
            scroll-behavior: smooth;
        }
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --bg-light: #ffffff;
            --bg-gray: #f7f8fa;
            --text-dark: #1a1a1a;
            --text-gray: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body[data-theme="blue"] {
            --primary: #3B82F6;
            --primary-dark: #2563EB;
            --gradient: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            --bg-light: #EFF6FF;
            --bg-gray: #DBEAFE;
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
        }

        body[data-theme="red"] {
            --primary: #EF4444;
            --primary-dark: #DC2626;
            --gradient: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            --bg-light: #FEF2F2;
            --bg-gray: #FEE2E2;
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
        }

        body[data-theme="pink"] {
            --primary: #EC4899;
            --primary-dark: #DB2777;
            --gradient: linear-gradient(135deg, #EC4899 0%, #DB2777 100%);
            --bg-light: #FCE7F3;
            --bg-gray: #FBCFE8;
            background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%);
        }

        body[data-theme="purple"] {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-light: #EDE9FE;
            --bg-gray: #DDD6FE;
            background: linear-gradient(135deg, #F3F4F6 0%, #EDE9FE 100%);
        }

        body[data-theme="green"] {
            --primary: #10B981;
            --primary-dark: #059669;
            --gradient: linear-gradient(135deg, #10B981 0%, #059669 100%);
            --bg-light: #ECFDF5;
            --bg-gray: #D1FAE5;
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
        }

        body[data-theme="orange"] {
            --primary: #F97316;
            --primary-dark: #EA580C;
            --gradient: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
            --bg-light: #FFF7ED;
            --bg-gray: #FED7AA;
            background: linear-gradient(135deg, #FFF7ED 0%, #FED7AA 100%);
        }

        body[data-theme="black"] {
            --primary: #6B7280;
            --primary-dark: #374151;
            --gradient: linear-gradient(135deg, #374151 0%, #000000 100%);
            --bg-light: #1F2937;
            --bg-gray: #111827;
            --text-dark: #F9FAFB;
            --text-gray: #9CA3AF;
            --border: #374151;
            background: linear-gradient(135deg, #1F2937 0%, #000000 100%);
        }

        body[data-theme="white"] {
            --primary: #6B7280;
            --primary-dark: #4B5563;
            --gradient: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            --bg-light: #FFFFFF;
            --bg-gray: #F9FAFB;
            --text-dark: #111827;
            --text-gray: #6B7280;
            --border: #E5E7EB;
            background: linear-gradient(135deg, #FFFFFF 0%, #F3F4F6 100%);
        }

        /* Темная тема с цветами */
        body.dark-theme[data-theme="blue"] {
            --bg-light: #1E3A8A;
            --bg-gray: #1E40AF;
            background: linear-gradient(135deg, #1E3A8A 0%, #111827 100%);
        }

        body.dark-theme[data-theme="red"] {
            --bg-light: #991B1B;
            --bg-gray: #B91C1C;
            background: linear-gradient(135deg, #991B1B 0%, #111827 100%);
        }

        body.dark-theme[data-theme="pink"] {
            --bg-light: #9F1239;
            --bg-gray: #BE185D;
            background: linear-gradient(135deg, #9F1239 0%, #111827 100%);
        }

        body.dark-theme[data-theme="green"] {
            --bg-light: #14532D;
            --bg-gray: #166534;
            background: linear-gradient(135deg, #14532D 0%, #111827 100%);
        }

        body.dark-theme[data-theme="orange"] {
            --bg-light: #7C2D12;
            --bg-gray: #9A3412;
            background: linear-gradient(135deg, #7C2D12 0%, #111827 100%);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            position: relative;
            color: var(--text-dark);
            transition: all 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        .page-container.active,
        .checkout-page.active {
            animation: fadeIn 0.3s ease;
        }
        /* Темная тема */
        body.dark-theme {
            --bg-light: #1a1a1a;
            --bg-gray: #2a2a2a;
            --text-dark: #ffffff;
            --text-gray: #9ca3af;
            --border: #374151;
            background: #0f0f0f;
        }

        /* Контейнер для начальных страниц */
        .setup-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--gradient);
            transition: all 0.5s ease;
        }

        .setup-container.light-theme {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .setup-container.dark-theme {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        .setup-page {
            background: var(--bg-light);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            display: none;
            animation: fadeInScale 0.5s ease;
        }

        .setup-page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .logo-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
        }

        .logo {
            width: 100%;
            height: 100%;
            border-radius: 24px;
            object-fit: cover;
            box-shadow: var(--shadow);
        }

        .setup-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--text-dark);
        }

        .theme-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .theme-option {
            height: 120px;
            border-radius: 16px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .theme-option:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .theme-option.dark {
            background: #1a1a1a;
            color: white;
        }

        .theme-option.light {
            background: white;
            color: #1a1a1a;
        }

        .theme-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .city-option {
            padding: 20px;
            border-radius: 16px;
            border: 2px solid var(--border);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .city-option:hover {
            border-color: var(--primary);
            background: var(--bg-gray);
        }

        .city-option.selected {
            border-color: var(--primary);
            background: var(--gradient);
            color: white;
        }

        .city-icon {
            font-size: 32px;
        }
        body, 
        .product-card,
        .category-card,
        .cart-item,
        .stat-card,
        .bottom-nav,
        .catalog-header,
        .setup-btn,
        .apply-btn,
        .checkout-btn {
        transition: background 0.5s ease, 
            color 0.3s ease, 
            border-color 0.3s ease,
            box-shadow 0.3s ease;
        }
        .setup-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .setup-btn.active {
            opacity: 1;
            pointer-events: auto;
        }

        .setup-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Основное приложение */
        .app-container {
            display: none;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .app-container.active {
            display: block;
        }

        /* Хедер каталога */
        .catalog-header {
            position: sticky;
            top: 0;
            background: var(--bg-light);
            z-index: 10;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .catalog-breadcrumb {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .catalog-category {
            color: var(--primary);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .control-btn:hover {
            background: var(--bg-gray);
            transform: translateY(-2px);
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-gray);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .saved-user-data {
    background: linear-gradient(135deg, var(--primary)10, var(--primary-dark)10);
    border: 1px solid var(--primary)20;
    border-radius: 14px;
    padding: 15px;
    margin-bottom: 20px;
}

.saved-data-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-size: 14px;
    font-weight: 600;
}

.mini-edit-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 12px;
    cursor: pointer;
    text-decoration: underline;
}

.saved-data-items {
    display: grid;
    gap: 8px;
}

.saved-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
}

.saved-icon {
    width: 20px;
    text-align: center;
}
        .search-bar:focus-within {
            box-shadow: 0 0 0 2px var(--primary);
        }

        .search-icon {
            color: var(--text-gray);
            font-size: 18px;
        }

        .search-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            font-size: 16px;
            color: var(--text-dark);
        }

        .search-input::placeholder {
            color: var(--text-gray);
        }

        /* ТАБЛИЦА КАТЕГОРИЙ */
        .categories-toggle-btn {
            width: calc(100% - 40px);
            margin: 15px 20px 0;
            padding: 14px;
            background: var(--gradient);
            border: none;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .categories-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .toggle-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .categories-toggle-btn.active .toggle-icon:last-child {
            transform: rotate(180deg);
        }

        .categories-panel {
            background: var(--bg-light);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .categories-panel.active {
            max-height: 500px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-top: none;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .category-card {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 15px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
        }

        .category-card.active {
            background: var(--gradient);
            color: white;
        }

        .category-emoji {
            font-size: 28px;
            margin-bottom: 6px;
            display: block;
        }

        .category-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .category-count {
            font-size: 10px;
            color: var(--text-gray);
        }

        .category-card.active .category-name,
        .category-card.active .category-count {
            color: white;
        }

        /* Продукты */
        .products-section {
            padding: 20px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .product-card {
            background: var(--bg-light);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gradient);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1;
        }

        .product-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: var(--bg-gray);
            transition: all 0.3s ease;
        }

        .product-info {
            padding: 12px;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .product-old-price {
            font-size: 14px;
            color: var(--text-gray);
            text-decoration: line-through;
            margin-left: 8px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .add-to-cart-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-to-cart-btn:hover {
            background: var(--primary-dark);
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .favorite-btn:hover {
            background: #fff5f5;
            border-color: #ff6b6b;
        }

        .favorite-btn.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
        }

        .info-btn:hover {
            background: var(--bg-gray);
            border-color: var(--primary);
        }

        /* Модальное окно подтверждения */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 800;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .confirm-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-content {
            background: var(--bg-light);
            border-radius: 20px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .confirm-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .confirm-message {
            font-size: 14px;
            text-align: center;
            color: var(--text-gray);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .confirm-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn.primary {
            background: var(--gradient);
            color: white;
        }

        .confirm-btn.secondary {
            background: var(--bg-gray);
            color: var(--text-dark);
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Модальное окно выбора цвета */
        .color-selector-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 700;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .color-selector-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-selector-content {
            background: var(--bg-light);
            border-radius: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .color-selector-header {
            padding: 25px 25px 20px;
            border-bottom: 1px solid var(--border);
        }

        .color-selector-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-dark);
        }

        .color-selector-subtitle {
            font-size: 14px;
            color: var(--text-gray);
        }

        .color-preview {
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .color-preview-image {
            width: 180px;
            height: 180px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .color-options {
            padding: 0 20px 20px;
        }

        .color-options-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .color-option {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .color-option:hover {
            transform: translateY(-4px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .color-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        .color-option.selected::after {
            content: '✓';
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .color-option-inner {
            width: 100%;
            height: 100%;
            border-radius: 9px;
        }
        .user-data-block {
            background: var(--bg-light);
            border-radius: 20px;
            padding: 25px;
            max-width: 420px;
            margin: 20px auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .user-data-display {
            background: var(--bg-gray);
            border-radius: 14px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .data-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }

        .data-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .data-label {
            font-size: 11px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .edit-data-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: var(--gradient);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* Модальное окно редактирования */
        .edit-data-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .edit-data-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-data-content {
            background: var(--bg-light);
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            animation: slideUp 0.3s ease;
        }

        .edit-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .edit-data-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-gray);
            cursor: pointer;
            font-size: 18px;
        }

        .edit-data-body {
            padding: 20px;
        }

        .edit-data-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .btn-cancel, .btn-save {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: var(--bg-gray);
            color: var(--text-dark);
        }

        .btn-save {
            background: var(--gradient);
            color: white;
        }
        .color-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px;
            font-size: 10px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .color-confirm-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Уведомление */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-light);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.3s ease;
        }

        .notification.active {
            transform: translateX(-50%) translateY(0);
        }

        .notification-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #10b981, #34d399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .notification-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Модальное окно товара */
        .product-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 500;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .product-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-modal-content {
            background: var(--bg-light);
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .product-modal-header {
            position: relative;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-close-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-gray);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-modal-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .product-modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .product-modal-price {
            font-size: 24px;
            color: var(--primary);
            font-weight: 700;
        }

        .product-details {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .detail-list {
            list-style: none;
        }

        .detail-item {
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .detail-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .detail-value {
            font-weight: 500;
            font-size: 14px;
        }

        .collapsible-section {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .collapsible-header {
            padding: 15px;
            background: var(--bg-gray);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: var(--bg-light);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-section.active .collapsible-content {
            max-height: 300px;
        }

        .collapsible-section.active .collapsible-arrow {
            transform: rotate(180deg);
        }

        /* Оформление заказа */
        .checkout-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient);
            z-index: 600;
            overflow-y: auto;
        }

        .checkout-container.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .checkout-page {
            background: var(--bg-light);
            border-radius: 24px;
            padding: 30px;
            max-width: 450px;
            width: 100%;
            display: none;
            animation: fadeInScale 0.4s ease;
        }

        .checkout-page.active {
            display: block;
        }

        .checkout-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }

        .delivery-option {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 16px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delivery-option:hover {
            border-color: var(--primary);
            background: var(--bg-gray);
        }

        .delivery-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .delivery-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }

        .delivery-option.selected .radio-circle,
        .payment-option.selected .radio-circle,
        .sort-option.selected .radio-circle {
            border-color: var(--primary);
        }

        .delivery-option.selected .radio-circle::after,
        .payment-option.selected .radio-circle::after,
        .sort-option.selected .radio-circle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }

        .delivery-name {
            font-size: 16px;
            font-weight: 600;
        }

        .delivery-info {
            margin-left: 35px;
            font-size: 13px;
            color: var(--text-gray);
            line-height: 1.5;
        }

        .delivery-costs {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .location-selector {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-gray);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .location-selector:hover {
            background: var(--bg-light);
        }

        .payment-option {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            border-color: var(--primary);
            background: var(--bg-gray);
        }

        .payment-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-label .required {
            color: #ef4444;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            background: var(--bg-gray);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-light);
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            background: var(--bg-gray);
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
            .form-input.error {
    border-color: #ef4444 !important;
    background: #fef2f2 !important;
}

.form-hint {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: var(--text-gray);
}

.form-hint.error {
    color: #ef4444;
}
        .checkout-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .checkout-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .checkout-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

/* Кнопка сброса */
        .reset-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-light);
            color: var(--text-gray);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reset-btn:hover {
            background: var(--bg-gray);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .reset-btn:active {
            transform: scale(0.98);
        }

        /* Улучшенные стили фильтров */
        .filter-subtitle {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-filter {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .price-input-group {
            position: relative;
            flex: 1;
        }

        .price-currency {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: var(--text-gray);
            pointer-events: none;
        }

        .price-input {
            padding-right: 40px;
            background: var(--bg-light);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .price-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .price-range-info {
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--bg-light);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-gray);
            text-align: center;
        }

        /* Анимация при сбросе */
        @keyframes resetPulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .resetting {
            animation: resetPulse 0.3s ease;
        }
        .order-summary {
            background: var(--bg-gray);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .summary-divider {
            height: 1px;
            background: var(--border);
            margin: 15px 0;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #10b981, #34d399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            animation: successPop 0.5s ease;
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .order-number {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .success-message {
            text-align: center;
            font-size: 16px;
            color: var(--text-gray);
            margin-bottom: 30px;
        }

        /* Модальное окно выбора места */
        .location-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-light);
            z-index: 700;
            padding: 20px;
        }

        .location-modal.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .location-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: var(--bg-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .location-title {
            font-size: 20px;
            font-weight: 600;
        }

        .location-list {
            margin-top: 20px;
        }

        .location-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-item:hover {
            background: var(--bg-gray);
            border-color: var(--primary);
        }

        .address-input-container {
            margin-top: 20px;
        }

        .address-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg-gray);
        }

        .address-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-light);
        }

        .confirm-location-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Нижняя навигация */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-light);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-gray);
            position: relative;
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-badge {
            position: absolute;
            top: 0;
            right: 30%;
            background: #ff6b6b;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        /* Модальные окна */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-light);
            border-radius: 24px 24px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 201;
            max-height: 50vh;
            overflow-y: auto;
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .sheet-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        .sort-option {
            display: flex;
            align-items: center;
            padding: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sort-option:hover {
            opacity: 0.7;
        }

        .sort-label {
            font-size: 16px;
            color: var(--text-dark);
            margin-left: 15px;
        }

        .apply-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            background: var(--gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Фильтры цены */
        .price-filter {
            margin: 20px 0;
        }

        .price-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .price-input-group {
            flex: 1;
        }

        .price-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 5px;
        }

        .price-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .price-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .price-separator {
            color: var(--text-gray);
            margin-top: 20px;
        }

        /* Полноэкранный поиск */
        .fullscreen-search {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-light);
            z-index: 300;
            padding: 20px;
        }

        .fullscreen-search.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-field {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--bg-gray);
        }

        .search-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-results {
            margin-top: 20px;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: var(--bg-gray);
        }

        .search-result-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .search-result-price {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        /* Страницы */
        .page-container {
            display: none;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .page-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        /* Корзина */
        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: var(--bg-gray);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .cart-item-price {
            font-size: 16px;
            color: var(--primary);
            font-weight: 600;
        }

        .cart-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
        }

        .quantity-value {
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* Профиль */
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            color: white;
            font-weight: 700;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 14px;
            color: var(--text-gray);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 0 auto 25px;
            max-width: 380px;
        }
        .stat-card {
            background: var(--bg-gray);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .stat-card:hover::before {
            opacity: 1;
        }
            .stat-icon {
    font-size: 24px;
    margin-bottom: 8px;
    opacity: 0.8;
}

.stat-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary);
    margin: 5px 0;
}

.stat-label {
    font-size: 12px;
    color: var(--text-gray);
    font-weight: 500;
}

/* Блок настроек темы */
.theme-settings-block {
    background: var(--bg-light);
    border-radius: 20px;
    padding: 25px;
    max-width: 420px;
    margin: 0 auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.settings-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-dark);
}

.title-icon {
    font-size: 22px;
}

/* Улучшенная сетка цветов */
.color-theme-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

@media (max-width: 400px) {
    .color-theme-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

.theme-color-option {
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 6px;
    border-radius: 12px;
    border: 2px solid transparent;
}

.theme-color-option:hover {
    transform: translateY(-3px);
    background: var(--bg-gray);
}

.theme-color-option.active {
    border-color: var(--primary);
    background: var(--bg-gray);
}

.theme-color-preview {
    width: 100%;
    height: 45px;
    border-radius: 10px;
    margin-bottom: 5px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.theme-color-option:hover .theme-color-preview {
    transform: scale(1.08);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
}

.theme-color-option span {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dark);
}

/* Красивый переключатель темной темы */
.dark-mode-toggle {
    background: var(--bg-gray);
    border-radius: 14px;
    padding: 16px;
    margin-top: 20px;
}

.toggle-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}

.toggle-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toggle-icon {
    font-size: 20px;
}

.toggle-text {
    font-size: 15px;
    font-weight: 500;
    color: var(--text-dark);
}

/* Стилизованный чекбокс */
.toggle-switch {
    position: relative;
    width: 48px;
    height: 26px;
    -webkit-appearance: none;
    appearance: none;
    background: #ccc;
    border-radius: 13px;
    outline: none;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle-switch::before {
    content: '';
    position: absolute;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: white;
    top: 2px;
    left: 2px;
    transition: transform 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.toggle-switch:checked {
    background: var(--primary);
}

.toggle-switch:checked::before {
    transform: translateX(22px);
}

/* Анимация появления блоков */
.profile-stats,
.theme-settings-block {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-gray);
        }

        /* Пустые состояния */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .empty-text {
            font-size: 14px;
            color: var(--text-gray);
        }
        .color-theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .theme-color-option {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid transparent;
        }

        .theme-color-option:hover {
            transform: translateY(-2px);
        }

        .theme-color-option.active {
            border-color: var(--primary);
            background: var(--bg-gray);
        }

        .theme-color-preview {
            width: 100%;
            height: 50px;
            border-radius: 10px;
            margin-bottom: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .theme-color-option:hover .theme-color-preview {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .theme-color-option span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-dark);
        }
        @media (min-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .categories-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .setup-page,
            .page-container {
                max-width: 600px;
                margin: 0 auto;
            }
        }

        @media (max-width: 360px) {
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ПРОДОЛЖЕНИЕ HTML В СЛЕДУЮЩЕМ СООБЩЕНИИ -->
     <!-- ПРОДОЛЖЕНИЕ HTML -->
<body>
    <!-- Начальные экраны -->
    <div class="setup-container" id="setupContainer">
        <!-- Выбор темы -->
        <div class="setup-page active" id="themePage">
            <div class="logo-container">
                <img src="logo.png" alt="Logo" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMjQiIGZpbGw9InVybCgjcGFpbnQwKSIvPgo8cGF0aCBkPSJNNjAgMzVDNDUuNjQgMzUgMzQgNDYuNjQgMzQgNjFDMzQgNzUuMzYgNDUuNjQgODcgNjAgODdDNzQuMzYgODcgODYgNzUuMzYgODYgNjFDODYgNDYuNjQgNzQuMzYgMzUgNjAgMzVaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0icGFpbnQwIiB4MT0iMCIgeTE9IjAiIHgyPSIxMjAiIHkyPSIxMjAiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N0VFQSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRCQTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4='">
            </div>
            <h1 class="setup-title">Выберите тему</h1>
            <div class="theme-selection">
                <div class="theme-option light" data-theme="light">
                    ☀️ Светлая
                </div>
                <div class="theme-option dark" data-theme="dark">
                    🌙 Тёмная
                </div>
            </div>
            <button class="setup-btn" id="themeNextBtn">Далее</button>
        </div>

        <!-- Выбор города -->
        <div class="setup-page" id="cityPage">
            <div class="logo-container">
                <img src="logo.png" alt="Logo" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMjQiIGZpbGw9InVybCgjcGFpbnQwKSIvPgo8cGF0aCBkPSJNNjAgMzVDNDUuNjQgMzUgMzQgNDYuNjQgMzQgNjFDMzQgNzUuMzYgNDUuNjQgODcgNjAgODdDNzQuMzYgODcgODYgNzUuMzYgODYgNjFDODYgNDYuNjQgNzQuMzYgMzUgNjAgMzVaIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0icGFpbnQwIiB4MT0iMCIgeTE9IjAiIHgyPSIxMjAiIHkyPSIxMjAiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N0VFQSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRCQTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4='">
            </div>
            <h1 class="setup-title">Выберите город</h1>
            <div class="city-selection">
                <div class="city-option" data-city="minsk">
                    <span class="city-icon">🏙️</span>
                    <div>
                        <div style="font-weight: 600;">Минск</div>
                        <div style="font-size: 14px; color: var(--text-gray);">Столица Беларуси</div>
                    </div>
                </div>
                <div class="city-option" data-city="molodechno">
                    <span class="city-icon">🌆</span>
                    <div>
                        <div style="font-weight: 600;">Молодечно</div>
                        <div style="font-size: 14px; color: var(--text-gray);">Город Беларуси</div>
                    </div>
                </div>
            </div>
            <button class="setup-btn" id="cityNextBtn">Начать</button>
        </div>
    </div>

    <!-- Основное приложение -->
    <div class="app-container" id="appContainer">
        <!-- Каталог -->
        <div class="catalog-page" id="catalogPage">
            <div class="catalog-header">
                
                <div class="header-top">
                    <div class="catalog-breadcrumb">
                        Каталог - <span class="catalog-category" id="currentCategory">Все</span>
                    </div>
                    <div class="header-controls">
                        <div class="control-btn" id="sortBtn">↓↑</div>
                        <div class="control-btn" id="filterBtn">⚙️</div>
                    </div>
                </div>
                <div class="search-bar">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" placeholder="Найти товар..." id="searchInput">
                </div>
            </div>

            <!-- ТАБЛИЦА КАТЕГОРИЙ -->
            <button class="categories-toggle-btn" id="categoriesToggle">
                <span>Категории товаров</span>
                <span class="toggle-icon">▼</span>
            </button>
            <div class="categories-panel" id="categoriesPanel">
                <div class="categories-grid">
                    <div class="category-card active" data-category="all">
                        <span class="category-emoji">🎯</span>
                        <div class="category-name">Все</div>
                        <div class="category-count">9 товаров</div>
                    </div>
                    <div class="category-card" data-category="liquids">
                        <span class="category-emoji">💧</span>
                        <div class="category-name">Жидкости</div>
                        <div class="category-count">3 товара</div>
                    </div>
                    <div class="category-card" data-category="vapes">
                        <span class="category-emoji">💨</span>
                        <div class="category-name">Вейпы</div>
                        <div class="category-count">2 товара</div>
                    </div>
                    <div class="category-card" data-category="disposable">
                        <span class="category-emoji">🔋</span>
                        <div class="category-name">Одноразки</div>
                        <div class="category-count">2 товара</div>
                    </div>
                    <div class="category-card" data-category="tobacco">
                        <span class="category-emoji">🚬</span>
                        <div class="category-name">Табак</div>
                        <div class="category-count">1 товар</div>
                    </div>
                    <div class="category-card" data-category="boosters">
                        <span class="category-emoji">⚡</span>
                        <div class="category-name">Бустеры</div>
                        <div class="category-count">1 товар</div>
                    </div>
                </div>
            </div>

            <div class="products-section">
                <div class="products-grid" id="productsGrid">
                    <!-- Товары добавятся через JS -->
                </div>
            </div>
        </div>

        <!-- Избранное -->
        <div class="page-container" id="favoritesPage">
            <h1 class="page-title">Избранное</h1>
            <div id="favoritesContent">
                <div class="empty-state">
                    <div class="empty-icon">❤️</div>
                    <div class="empty-title">Нет избранных товаров</div>
                    <div class="empty-text">Добавляйте товары в избранное, чтобы быстро найти их позже</div>
                </div>
            </div>
        </div>

        <!-- Корзина -->
        <div class="page-container" id="cartPage">
            <h1 class="page-title">Корзина</h1>
            <div id="cartContent">
                <div class="empty-state">
                    <div class="empty-icon">🛒</div>
                    <div class="empty-title">Корзина пуста</div>
                    <div class="empty-text">Добавьте товары из каталога</div>
                </div>
            </div>
        </div>

        <!-- Профиль -->
 <div class="page-container" id="profilePage">
    <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-name" id="profileName">Пользователь</div>
        <div class="profile-id">ID: <span id="profileId">1</span></div>
    </div>
    
    <!-- БЛОК СТАТИСТИКИ (2x2 сетка) -->
    <div class="profile-stats">
        <div class="stat-card">
            <div class="stat-icon">🛒</div>
            <div class="stat-value" id="cartCount">0</div>
            <div class="stat-label">В корзине</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">❤️</div>
            <div class="stat-value" id="favCount">0</div>
            <div class="stat-label">Избранное</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">💰</div>
            <div class="stat-value" id="totalAmount">0 BYN</div>
            <div class="stat-label">Сумма</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">🎁</div>
            <div class="stat-value">0%</div>
            <div class="stat-label">Скидка</div>
        </div>
    </div>
        <div class="user-data-block">
        <h3 class="settings-title">
            <span class="title-icon">📋</span>
            Мои данные
        </h3>
        
        <div class="user-data-display" id="userDataDisplay">
            <div class="data-item">
                <span class="data-icon">👤</span>
                <div class="data-info">
                    <span class="data-label">ФИО</span>
                    <span class="data-value" id="displayUserName">Не указано</span>
                </div>
            </div>
            <div class="data-item">
                <span class="data-icon">📱</span>
                <div class="data-info">
                    <span class="data-label">Телефон</span>
                    <span class="data-value" id="displayUserPhone">Не указано</span>
                </div>
            </div>
            <div class="data-item">
                <span class="data-icon">💬</span>
                <div class="data-info">
                    <span class="data-label">Telegram</span>
                    <span class="data-value" id="displayUserTelegram">Не указано</span>
                </div>
            </div>
        </div>
        
        <button class="edit-data-btn" onclick="openEditData()">
            ✏️ Изменить данные
        </button>
    </div>
    <div class="edit-data-modal" id="editDataModal">
        <div class="edit-data-content">
            <div class="edit-data-header">
                <h3>Редактирование данных</h3>
                <button class="close-btn" onclick="closeEditData()">✕</button>
            </div>
            
            <div class="edit-data-body">
                <div class="form-group">
                    <label class="form-label">ФИО</label>
                    <input type="text" class="form-input" id="editFullName" placeholder="Иванов Иван Иванович">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Телефон</label>
                    <input type="tel" class="form-input" id="editPhone" placeholder="+375291234567">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telegram</label>
                    <input type="text" class="form-input" id="editTelegram" placeholder="@username">
                </div>
            </div>
            
            <div class="edit-data-footer">
                <button class="btn-cancel" onclick="closeEditData()">Отмена</button>
                <button class="btn-save" onclick="saveEditedData()">💾 Сохранить</button>
            </div>
        </div>
    </div>
    <!-- БЛОК НАСТРОЕК ТЕМЫ (отдельно от статистики) -->
    <div class="theme-settings-block">
        <h3 class="settings-title">
            <span class="title-icon">🎨</span>
            Персонализация
        </h3>
        
        <div class="color-theme-grid">
            <div class="theme-color-option" data-color="purple" onclick="changeThemeColor('purple')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #667eea, #764ba2)"></div>
                <span>Фиолет</span>
            </div>
            <div class="theme-color-option" data-color="blue" onclick="changeThemeColor('blue')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #3B82F6, #2563EB)"></div>
                <span>Синий</span>
            </div>
            <div class="theme-color-option" data-color="red" onclick="changeThemeColor('red')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #EF4444, #DC2626)"></div>
                <span>Красный</span>
            </div>
            <div class="theme-color-option" data-color="pink" onclick="changeThemeColor('pink')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #EC4899, #DB2777)"></div>
                <span>Розовый</span>
            </div>
            <div class="theme-color-option" data-color="green" onclick="changeThemeColor('green')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #10B981, #059669)"></div>
                <span>Зеленый</span>
            </div>
            <div class="theme-color-option" data-color="orange" onclick="changeThemeColor('orange')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #F97316, #EA580C)"></div>
                <span>Оранж</span>
            </div>
            <div class="theme-color-option" data-color="black" onclick="changeThemeColor('black')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #374151, #000000)"></div>
                <span>Черный</span>
            </div>
            <div class="theme-color-option" data-color="white" onclick="changeThemeColor('white')">
                <div class="theme-color-preview" style="background: linear-gradient(135deg, #FFFFFF, #E5E7EB); border: 1px solid #E5E7EB;"></div>
                <span>Белый</span>
            </div>
        </div>
        
        <!-- Переключатель темной темы -->
        <div class="dark-mode-toggle">
            <label class="toggle-label">
                <div class="toggle-info">
                    <span class="toggle-icon">🌙</span>
                    <span class="toggle-text">Темная тема</span>
                </div>
                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" class="toggle-switch">
            </label>
        </div>
    </div>
</div>
    </div>

    <!-- Модальное окно подтверждения -->
    <div class="confirm-modal" id="confirmModal" onclick="closeConfirmOnBackground(event)">
        <div class="confirm-content" onclick="event.stopPropagation()">
            <div class="confirm-icon" id="confirmIcon">❓</div>
            <h3 class="confirm-title" id="confirmTitle">Подтверждение</h3>
            <p class="confirm-message" id="confirmMessage">Вы уверены?</p>
            <div class="confirm-buttons">
                <button class="confirm-btn secondary" id="confirmCancel">Нет</button>
                <button class="confirm-btn primary" id="confirmOk">Да</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора цвета -->
    <div class="color-selector-modal" id="colorSelectorModal" onclick="closeColorSelectorOnBackground(event)">
        <div class="color-selector-content" onclick="event.stopPropagation()">
            <div class="color-selector-header">
                <h3 class="color-selector-title" id="colorSelectorTitle">Выберите цвет</h3>
                <p class="color-selector-subtitle">Выберите желаемый цвет товара</p>
            </div>
            <div class="color-preview">
                <img src="" alt="" class="color-preview-image" id="colorPreviewImage">
            </div>
            <div class="color-options">
                <p class="color-options-title">Доступные цвета:</p>
                <div class="color-grid" id="colorGrid">
                    <!-- Цвета добавятся через JS -->
                </div>
                <button class="color-confirm-btn" id="colorConfirmBtn">Добавить в корзину</button>
            </div>
        </div>
    </div>

    <!-- Уведомление -->
    <div class="notification" id="notification">
        <div class="notification-icon">✓</div>
        <span class="notification-text" id="notificationText">Товар добавлен</span>
    </div>

    <!-- Модальное окно товара -->
    <div class="product-modal" id="productModal" onclick="closeProductModalOnBackground(event)">
        <div class="product-modal-content" onclick="event.stopPropagation()">
            <div class="product-modal-header">
                <button class="modal-close-btn" onclick="closeProductModal()">✕</button>
                <img src="" alt="" class="product-modal-image" id="modalImage">
                <h2 class="product-modal-title" id="modalTitle"></h2>
                <div class="product-modal-price" id="modalPrice"></div>
            </div>
            <div class="product-details">
                <div class="collapsible-section active">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>📝 Описание</span>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                    <div class="collapsible-content" style="max-height: 300px;">
                        <p id="modalDescription" style="padding: 15px; line-height: 1.6;"></p>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>📊 Характеристики</span>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <ul class="detail-list" id="modalSpecs" style="padding: 15px;">
                            <!-- Характеристики добавятся через JS -->
                        </ul>
                    </div>
                </div>

                <button class="checkout-btn" onclick="addToCartFromModal()">Добавить в корзину</button>
            </div>
        </div>
    </div>

    <!-- Оформление заказа -->
    <div class="checkout-container" id="checkoutContainer">
        <!-- Шаг 1: Выбор доставки -->
        <div class="checkout-page active" id="deliveryPage">
            <h2 class="checkout-title">Способ доставки</h2>
            
            <div class="delivery-option" data-delivery="minsk">
                <div class="delivery-header">
                    <div class="radio-circle"></div>
                    <div class="delivery-name">Минск</div>
                </div>
                <div class="delivery-info">
                    Данный способ доставки осуществляется через банковскую карту и наличные средства.
                    <div class="delivery-costs">
                        <div class="cost-item">
                            <span>Стоимость доставки:</span>
                            <span>0 BYN</span>
                        </div>
                        <div class="cost-item">
                            <span>От заказа:</span>
                            <span>5 BYN</span>
                        </div>
                    </div>
                    <div class="location-selector" onclick="openLocationModal('minsk')">
                        <span>Выбрать место встречи</span>
                        <span>▶</span>
                    </div>
                </div>
            </div>

            <div class="delivery-option" data-delivery="address">
                <div class="delivery-header">
                    <div class="radio-circle"></div>
                    <div class="delivery-name">Доставка на свой адрес</div>
                </div>
                <div class="delivery-info">
                    Данный способ осуществляется через банковскую карту и наличные средства.
                    <div class="delivery-costs">
                        <div class="cost-item">
                            <span>Стоимость доставки:</span>
                            <span>3 BYN</span>
                        </div>
                        <div class="cost-item">
                            <span>От заказа:</span>
                            <span>15 BYN</span>
                        </div>
                    </div>
                    <div class="location-selector" onclick="openLocationModal('address')">
                        <span>Ввести место встречи</span>
                        <span>▶</span>
                    </div>
                </div>
            </div>

            <div class="delivery-option" data-delivery="krasnoe">
                <div class="delivery-header">
                    <div class="radio-circle"></div>
                    <div class="delivery-name">Красное</div>
                </div>
                <div class="delivery-info">
                    Данный способ осуществляется через банковскую карту и наличные средства.
                    <div class="delivery-costs">
                        <div class="cost-item">
                            <span>Стоимость доставки:</span>
                            <span>2 BYN</span>
                        </div>
                        <div class="cost-item">
                            <span>От заказа:</span>
                            <span>12 BYN</span>
                        </div>
                    </div>
                    <div class="location-selector" onclick="openLocationModal('krasnoe')">
                        <span>Выбрать место встречи</span>
                        <span>▶</span>
                    </div>
                </div>
            </div>

            <button class="checkout-btn" id="deliveryNextBtn" disabled onclick="goToPayment()">Далее</button>
        </div>

        <!-- Шаг 2: Способ оплаты -->
        <div class="checkout-page" id="paymentPage">
            <h2 class="checkout-title">Способ оплаты</h2>
            
            <div class="payment-option" data-payment="cash">
                <div class="radio-circle"></div>
                <span>💵 Наличные</span>
            </div>
            
            <div class="payment-option" data-payment="card">
                <div class="radio-circle"></div>
                <span>💳 Перевод на карту</span>
            </div>

            <button class="checkout-btn" id="paymentNextBtn" disabled onclick="goToContactsFix()">Далее</button>
        </div>

        <!-- Шаг 3: Контактные данные -->
        <div class="checkout-page" id="contactsPage">
            <h2 class="checkout-title">Контактные данные</h2>
        <div class="checkout-page" id="contactsPageSimple">
    <h2 class="checkout-title">📍 Детали доставки</h2>
    
    <!-- Красивое отображение сохраненных данных -->
    <div class="saved-user-data">
        <div class="saved-data-header">
            <span>✅ Ваши данные</span>
            <button class="mini-edit-btn" onclick="openEditData()">изменить</button>
        </div>
        <div class="saved-data-items">
            <div class="saved-item">
                <span class="saved-icon">👤</span>
                <span class="saved-text" id="checkoutName"></span>
            </div>
            <div class="saved-item">
                <span class="saved-icon">📱</span>
                <span class="saved-text" id="checkoutPhone"></span>
            </div>
            <div class="saved-item">
                <span class="saved-icon">💬</span>
                <span class="saved-text" id="checkoutTelegram"></span>
            </div>
        </div>
    </div>
    
    <!-- Только время и комментарий -->
    <div class="form-group">
        <label class="form-label">⏰ Время встречи <span class="required">*</span></label>
        <input type="text" class="form-input" id="meetTimeSimple" placeholder="15:00" maxlength="5">
    </div>
    
    <div class="form-group">
        <label class="form-label">💭 Комментарий (необязательно)</label>
        <textarea class="form-textarea" id="commentSimple" placeholder="Дополнительные пожелания..."></textarea>
    </div>
    
    <button class="checkout-btn" onclick="goToSummarySimple()">Продолжить</button>
</div>
<div class="form-group">
    <label class="form-label">ФИО <span class="required">*</span></label>
    <input type="text" class="form-input" id="fullName" placeholder="Иванов Иван Иванович">
    <small class="form-hint" style="color: var(--text-gray); font-size: 12px; margin-top: 5px; display: block;">
        Введите фамилию, имя и отчество через пробел
    </small>
</div>

<!-- После поля телефона -->
<div class="form-group">
    <label class="form-label">Номер телефона <span class="required">*</span></label>
    <input type="tel" class="form-input" id="phone" placeholder="+375291234567" maxlength="13">
    <small class="form-hint" style="color: var(--text-gray); font-size: 12px; margin-top: 5px; display: block;">
        Формат: +375XXXXXXXXX (12 цифр)
    </small>
</div>

<!-- После поля Telegram -->
<div class="form-group">
    <label class="form-label">Telegram Username <span class="required">*</span></label>
    <input type="text" class="form-input" id="telegram" placeholder="@username">
    <small class="form-hint" style="color: var(--text-gray); font-size: 12px; margin-top: 5px; display: block;">
        Начните с символа @
    </small>
</div>

<!-- После поля времени -->
<div class="form-group">
    <label class="form-label">Время встречи <span class="required">*</span></label>
    <input type="text" class="form-input" id="meetTime" placeholder="15:00" maxlength="5">
    <small class="form-hint" style="color: var(--text-gray); font-size: 12px; margin-top: 5px; display: block;">
        Формат: ЧЧ:ММ (например: 15:00)
    </small>
</div>
        <button class="checkout-btn" id="contactsNextBtn" disabled onclick="goToSummary()">Далее</button>
        </div>

        <!-- Шаг 4: Подтверждение -->
        <div class="checkout-page" id="summaryPage">
            <h2 class="checkout-title">Завершение оформления</h2>
            
            <div class="order-summary" id="orderSummary">
                <!-- Информация о заказе добавится через JS -->
            </div>

            <button class="checkout-btn" onclick="confirmOrder()">Подтвердить заказ</button>
        </div>

        <!-- Успешный заказ -->
        <div class="checkout-page" id="successPage">
            <div class="success-icon">✓</div>
            <div class="order-number" id="orderNumber">Заказ #12345</div>
            <div class="success-message">Успешно создан!</div>
            <p style="text-align: center; color: var(--text-gray); margin-bottom: 30px;">
                Ожидайте подтверждения от оператора
            </p>
            <button class="checkout-btn" onclick="closeCheckout()">Вернуться в каталог</button>
        </div>
    </div>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="checkout-btn" style="background: #0088cc;" onclick="contactSeller()">
            💬 Связь с продавцом
        </button>
        <button class="checkout-btn" style="background: #ef4444;" onclick="cancelOrder()">
            ❌ Отменить заказ
        </button>
    </div>
    <!-- Модальное окно выбора места -->
    <div class="location-modal" id="locationModal">
        <div class="location-header">
            <button class="back-btn" onclick="closeLocationModal()">←</button>
            <h2 class="location-title" id="locationTitle">Выберите место</h2>
        </div>
        
        <div id="locationContent">
            <!-- Контент добавится через JS -->
        </div>
    </div>

    <!-- Нижняя навигация -->
    <div class="bottom-nav" id="bottomNav" style="display: none;">
        <div class="nav-item active" data-page="catalog">
            <span class="nav-icon">📦</span>
            <span class="nav-label">Каталог</span>
        </div>
        <div class="nav-item" data-page="search">
            <span class="nav-icon">🔍</span>
            <span class="nav-label">Поиск</span>
        </div>
        <div class="nav-item" data-page="favorites">
            <span class="nav-icon">❤️</span>
            <span class="nav-label">Избранное</span>
            <span class="nav-badge" id="favBadge" style="display: none;">0</span>
        </div>
        <div class="nav-item" data-page="cart">
            <span class="nav-icon">🛒</span>
            <span class="nav-label">Корзина</span>
            <span class="nav-badge" id="cartBadge" style="display: none;">0</span>
        </div>
        <div class="nav-item" data-page="profile">
            <span class="nav-icon">👤</span>
            <span class="nav-label">Профиль</span>
        </div>
    </div>

    <!-- Модальное окно сортировки -->
    <div class="modal-overlay" id="sortOverlay"></div>
    <div class="bottom-sheet" id="sortSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Сортировка</h2>
            <button class="reset-btn" onclick="resetSort()">
                🔄 Сбросить
            </button>
        </div>
        <div class="sort-options">
            <div class="sort-option selected" data-sort="default">
                <div class="radio-circle"></div>
                <span class="sort-label">По умолчанию</span>
            </div>
            <div class="sort-option" data-sort="cheap">
                <div class="radio-circle"></div>
                <span class="sort-label">Сначала дешевле</span>
            </div>
            <div class="sort-option" data-sort="expensive">
                <div class="radio-circle"></div>
                <span class="sort-label">Сначала дороже</span>
            </div>
        </div>
        <button class="apply-btn" id="applySortBtn">Применить</button>
    </div>

    <!-- Модальное окно фильтров -->
    <div class="bottom-sheet" id="filterSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 class="sheet-title">Фильтры</h2>
            <button class="reset-btn" onclick="resetFilters()">
                🔄 Сбросить
            </button>
        </div>
        <div class="price-filter">
            <h3 class="filter-subtitle">💰 Диапазон цен</h3>
            <div class="price-inputs">
                <div class="price-input-group">
                    <div class="price-label">От</div>
                    <input type="number" class="price-input" id="priceFrom" placeholder="0" value="0">
                    <span class="price-currency">BYN</span>
                </div>
                <span class="price-separator">—</span>
                <div class="price-input-group">
                    <div class="price-label">До</div>
                    <input type="number" class="price-input" id="priceTo" placeholder="1000" value="1000">
                    <span class="price-currency">BYN</span>
                </div>
            </div>
            <div class="price-range-info">
                <span id="priceRangeText">Показаны все товары</span>
            </div>
        </div>
        <button class="apply-btn" id="applyFilterBtn">Применить</button>
    </div>

    <!-- Полноэкранный поиск -->
    <div class="fullscreen-search" id="fullscreenSearch">
        <div class="search-header">
            <button class="back-btn" id="searchBackBtn">←</button>
            <input type="text" class="search-field" placeholder="Поиск товаров..." id="fullSearchInput" autofocus>
        </div>
        <div class="search-results" id="searchResults">
            <!-- Результаты поиска -->
        </div>
    </div>

    <script>
        // JAVASCRIPT ПРОДОЛЖЕНИЕ В СЛЕДУЮЩЕМ СООБЩЕНИИ
    </script>
</body>
</html>
<script>
// Инициализация
const tg = window.Telegram ? window.Telegram.WebApp : null;
if (tg) {
    tg.ready();
    tg.expand();
    
    // Обработка кнопки назад
    tg.BackButton.onClick(() => {
        showExitConfirm();
    });
}

// Скрытие клавиатуры при потере фокуса
document.addEventListener('click', function(e) {
    if (!e.target.matches('input, textarea')) {
        document.activeElement.blur();
    }
});

// Данные приложения
const appData = {
    theme: null,
    city: null,
    themeColor: 'purple',
    cart: [],
    favorites: [],
    currentCategory: 'all',
    sortType: 'default',
    priceFilter: { from: 0, to: 1000 },
    currentProductModal: null,
    pendingProduct: null,
    selectedColor: null,
    order: {
        delivery: null,
        location: null,
        payment: null,
        contact: {}
    }
};

// Расширенная база товаров с цветами
const products = {
    liquids: [
        { 
            id: 1, 
            name: "Fruit Mix Premium", 
            price: 15, 
            oldPrice: 18, 
            category: "Жидкости", 
            categoryId: "liquids", 
            image: "https://i.ibb.co/WNHVkZ2P/zhidkost-premium-pod-mix-fruit-extra-ice-miks-fruktoviy-ekstra-led-10ml.webp", 
            badge: "Хит",
            description: "Премиальная жидкость с насыщенным фруктовым вкусом. Идеальное сочетание манго, маракуйи и личи.",
            specs: {
                "Объем": "30мл",
                "Никотин": "3мг",
                "VG/PG": "70/30",
                "Производитель": "Malaysia"
            },
            colors: null // Жидкости без выбора цвета
        },
        { 
            id: 2, 
            name: "Ice Mint Fresh", 
            price: 12, 
            category: "Жидкости", 
            categoryId: "liquids", 
            image: "https://i.ibb.co/JFrHG9Zt/3ger-salt-ice-mint-2-1000x1000.webp",
            description: "Освежающая мятная жидкость с холодком.",
            specs: {
                "Объем": "30мл",
                "Никотин": "6мг",
                "VG/PG": "50/50",
                "Производитель": "USA"
            },
            colors: null
        },
        { 
            id: 3, 
            name: "Berry Blast", 
            price: 14, 
            category: "Жидкости", 
            categoryId: "liquids", 
            image: "https://i.ibb.co/Wvg8gX8K/nab-r-dr-cloud-berry-blast-1-600x600.jpg",
            badge: "Новинка",
            description: "Взрывной микс лесных ягод.",
            specs: {
                "Объем": "30мл",
                "Никотин": "0мг",
                "VG/PG": "80/20",
                "Производитель": "UK"
            },
            colors: null
        }
    ],
    vapes: [
        { 
            id: 4, 
            name: "VaporMax Pro", 
            price: 120, 
            oldPrice: 140, 
            category: "Вейпы", 
            categoryId: "vapes", 
            image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg",
            description: "Профессиональный вейп с регулировкой мощности до 200W.",
            specs: {
                "Мощность": "5-200W",
                "Батарея": "2x18650",
                "Дисплей": "TFT 0.96",
                "Режимы": "VW/TC/TCR"
            },
            colors: [
                { name: "Черный", color: "#000000", image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg" },
                { name: "Серебро", color: "#C0C0C0", image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg" },
                { name: "Синий", color: "#0066CC", image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg" },
                { name: "Красный", color: "#FF0000", image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg" },
                { name: "Золотой", color: "#FFD700", image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg" },
                { name: "Розовый", color: "#FFC0CB", image: "https://i.ibb.co/Q7xdLt4B/voopoo-vthru-pro-pod-kit-neon.jpg" }
            ]
        },
        { 
            id: 5, 
            name: "Cloud Beast", 
            price: 95, 
            category: "Вейпы", 
            categoryId: "vapes", 
            image: "https://i.ibb.co/1t0d4Bxq/smoktvf8cloudbeasttank.webp",
            description: "Мощный вейп для больших облаков.",
            specs: {
                "Мощность": "5-150W",
                "Батарея": "2x18650",
                "Дисплей": "OLED",
                "Режимы": "VW/VV"
            },
            colors: [
                { name: "Черный", color: "#000000", image: "https://i.ibb.co/1t0d4Bxq/smoktvf8cloudbeasttank.webp" },
                { name: "Белый", color: "#FFFFFF", image: "https://i.ibb.co/1t0d4Bxq/smoktvf8cloudbeasttank.webp" },
                { name: "Радуга", color: "linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)", image: "https://via.placeholder.com/200/FF00FF/ffffff?text=Rainbow" }
            ]
        }
    ],
    disposable: [
        { 
            id: 6, 
            name: "ElfBar 5000", 
            price: 25, 
            category: "Одноразки", 
            categoryId: "disposable", 
            image: "https://i.ibb.co/23vHZ9zn/elf-bar-bc-5000-cranberry-grape-1-380x380.webp", 
            badge: "Топ",
            description: "Популярная одноразка на 5000 затяжек.",
            specs: {
                "Затяжки": "5000",
                "Батарея": "650mAh",
                "Никотин": "20мг",
                "Вкус": "Арбуз"
            },
            colors: [
                { name: "Арбуз", color: "#FF1744", image: "https://i.ibb.co/23vHZ9zn/elf-bar-bc-5000-cranberry-grape-1-380x380.webp" },
                { name: "Манго", color: "#FFA726", image: "https://i.ibb.co/23vHZ9zn/elf-bar-bc-5000-cranberry-grape-1-380x380.webp" },
                { name: "Мята", color: "#66BB6A", image: "https://i.ibb.co/23vHZ9zn/elf-bar-bc-5000-cranberry-grape-1-380x380.webp" },
                { name: "Черника", color: "#5C6BC0", image: "https://i.ibb.co/23vHZ9zn/elf-bar-bc-5000-cranberry-grape-1-380x380.webp" }
            ]
        },
        { 
            id: 7, 
            name: "HQD Cuvie", 
            price: 22, 
            category: "Одноразки", 
            categoryId: "disposable", 
            image: "https://i.ibb.co/cKgML4zD/energy-drink-800x600.jpg",
            description: "Компактная одноразка на 3000 затяжек.",
            specs: {
                "Затяжки": "3000",
                "Батарея": "500mAh",
                "Никотин": "20мг"
            },
            colors: [
                { name: "Кола", color: "#3E2723", image: "https://i.ibb.co/9HGhLGB1/ice-cola-800x600.jpg" },
                { name: "Энергетик", color: "#FFEB3B", image: "https://i.ibb.co/cKgML4zD/energy-drink-800x600.jpg" }
            ]
        }
    ],
    tobacco: [
        { 
            id: 8, 
            name: "Parliament Aqua", 
            price: 6, 
            category: "Табак", 
            categoryId: "tobacco", 
            image: "https://i.ibb.co/YTyGK1hg/124846.png",
            description: "Классические сигареты с аквафильтром.",
            specs: {
                "Количество": "20 шт",
                "Никотин": "0.5мг",
                "Смола": "5мг"
            },
            colors: null
        }
    ],
    boosters: [
        { 
            id: 9, 
            name: "NicBoost 20mg", 
            price: 4, 
            category: "Бустеры", 
            categoryId: "boosters", 
            image: "https://i.ibb.co/MyV8j3HR/9ff979adf5647f0443e28c700cf460dfcf477367-600x600.webp",
            description: "Никотиновый бустер для жидкостей.",
            specs: {
                "Объем": "10мл",
                "Никотин": "20мг",
                "VG/PG": "50/50"
            },
            colors: null
        }
    ]
};

const allProducts = Object.values(products).flat();
function closeProductModalOnBackground(event) {
    if (event.target.id === 'productModal') {
        closeProductModal();
    }
}
function updateCategoryCounters() {
    const categories = {
        all: allProducts.length,
        liquids: products.liquids?.length || 0,
        vapes: products.vapes?.length || 0,
        disposable: products.disposable?.length || 0,
        tobacco: products.tobacco?.length || 0,
        boosters: products.boosters?.length || 0
    };
    
    Object.keys(categories).forEach(cat => {
        const card = document.querySelector(`.category-card[data-category="${cat}"] .category-count`);
        if (card) {
            const count = categories[cat];
            card.textContent = `${count} ${count === 1 ? 'товар' : count < 5 ? 'товара' : 'товаров'}`;
        }
    });
}
function openEditData() {
    const modal = document.getElementById('editDataModal');
    
    // Заполняем текущими данными
    if (appData.userData) {
        document.getElementById('editFullName').value = appData.userData.fullName || '';
        document.getElementById('editPhone').value = appData.userData.phone || '';
        document.getElementById('editTelegram').value = appData.userData.telegram || '';
    }
    
    modal.classList.add('active');
}

// Закрытие модалки
function closeEditData() {
    document.getElementById('editDataModal').classList.remove('active');
}

// Сохранение измененных данных
function saveEditedData() {
    const fullName = document.getElementById('editFullName').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const telegram = document.getElementById('editTelegram').value.trim();
    
    // Валидация
    if (fullName.length < 3 || phone.length < 10 || !telegram.startsWith('@')) {
        showNotification('⚠️ Заполните все поля корректно');
        return;
    }
    
    // Сохраняем
    appData.userData = {
        fullName: fullName,
        phone: phone,
        telegram: telegram,
        saved: true
    };
    
    saveAppData();
    updateUserDataDisplay();
    closeEditData();
    showNotification('✅ Данные успешно обновлены');
}

// Обновление отображения данных
function updateUserDataDisplay() {
    if (appData.userData && appData.userData.saved) {
        document.getElementById('displayUserName').textContent = appData.userData.fullName;
        document.getElementById('displayUserPhone').textContent = appData.userData.phone;
        document.getElementById('displayUserTelegram').textContent = appData.userData.telegram;
        
        // Обновляем в checkout если открыт
        if (document.getElementById('checkoutName')) {
            document.getElementById('checkoutName').textContent = appData.userData.fullName;
            document.getElementById('checkoutPhone').textContent = appData.userData.phone;
            document.getElementById('checkoutTelegram').textContent = appData.userData.telegram;
        }
    }
}

// Упрощенный переход к сводке (для повторных заказов)
function goToSummarySimple() {
    const meetTime = document.getElementById('meetTimeSimple').value;
    if (!meetTime) {
        showNotification('⚠️ Укажите время встречи');
        return;
    }
    
    appData.order.contact = {
        ...appData.userData,
        meetTime: meetTime,
        comment: document.getElementById('commentSimple').value
    };
    
    // Формируем сводку и переходим
    showCheckoutPage('summaryPage');
    // ... остальной код
}

// Обновите updateProfile чтобы показывать данные
function updateProfile() {
    // ... существующий код ...
    
    // Показываем сохраненные данные пользователя
    updateUserDataDisplay();
}
function loadProducts() {
    showLoader(true);
    setTimeout(() => {
        displayProducts();
        showLoader(false);
    }, 300);
}
function showLoader(show = true) {
    let loader = document.getElementById('loader');
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'loader';
        loader.innerHTML = '<div class="spinner"></div>';
        loader.style.cssText = `
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            z-index: 9999; display: none;
        `;
        document.body.appendChild(loader);
    }
    loader.style.display = show ? 'block' : 'none';
}

function closeConfirmOnBackground(event) {
    if (event.target.id === 'confirmModal') {
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('active');
        // Если была функция отмены, вызываем её
        if (window.confirmCancelCallback) {
            window.confirmCancelCallback();
            window.confirmCancelCallback = null;
        }
    }
}

// Закрытие окна выбора цвета при клике на фон
function closeColorSelectorOnBackground(event) {
    if (event.target.id === 'colorSelectorModal') {
        const modal = document.getElementById('colorSelectorModal');
        modal.classList.remove('active');
        // Сбрасываем выбранный цвет
        appData.selectedColor = null;
        appData.pendingProduct = null;
    }
}

function loadAppData() {
    const saved = localStorage.getItem('vapeShopData');
    if (saved) {
        try {
            const savedData = JSON.parse(saved);
            
            // Восстанавливаем данные
            appData.favorites = savedData.favorites || [];
            appData.theme = savedData.theme;
            appData.city = savedData.city;
            appData.themeColor = savedData.themeColor || 'purple';
            
            console.log('Загружены данные:', savedData); // для отладки
            
            // Если уже выбрана тема и город, пропускаем onboarding
            if (appData.theme && appData.city) {
                // Скрываем экран настройки
                document.getElementById('setupContainer').style.display = 'none';
                
                // Показываем основное приложение
                document.getElementById('appContainer').classList.add('active');
                document.getElementById('bottomNav').style.display = 'flex';
                document.getElementById('catalogPage').style.display = 'block';
                
                // Применяем сохраненную тему
                if (appData.theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
                if (appData.themeColor) {
                    document.body.setAttribute('data-theme', appData.themeColor);
                }
                
                // Инициализируем каталог
                initCatalog();
                updateBadges(); // Обновляем бейджи для избранного
                
                return true; // Данные загружены
            }
        } catch (e) {
            console.error('Ошибка загрузки данных:', e);
        }
    }
    return false; // Данные не загружены или первый вход
}

// Сохранение данных
function saveAppData() {
    const dataToSave = {
        favorites: appData.favorites,
        theme: appData.theme,
        city: appData.city,
        themeColor: appData.themeColor
    };
    localStorage.setItem('vapeShopData', JSON.stringify(dataToSave));
}

// Показ подтверждения выхода
function showExitConfirm() {
    showConfirm(
        '⚠️',
        'Вы действительно хотите выйти?',
        'Ваша корзина не сохранится',
        () => {
            if (tg) {
                tg.close();
            }
        },
        () => {}
    );
}

// Универсальная функция подтверждения
function showConfirm(icon, title, message, onConfirm, onCancel) {
    const modal = document.getElementById('confirmModal');
    document.getElementById('confirmIcon').textContent = icon;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    
    modal.classList.add('active');
    
    // Сохраняем callback отмены глобально
    window.confirmCancelCallback = onCancel;
    
    document.getElementById('confirmOk').onclick = () => {
        modal.classList.remove('active');
        window.confirmCancelCallback = null;
        onConfirm();
    };
    
    document.getElementById('confirmCancel').onclick = () => {
        modal.classList.remove('active');
        window.confirmCancelCallback = null;
        onCancel();
    };
}

// Показ уведомления
function showNotification(text) {
    const notification = document.getElementById('notification');
    document.getElementById('notificationText').textContent = text;
    notification.classList.add('active');
    
    setTimeout(() => {
        notification.classList.remove('active');
    }, 3000);
}

// Функция добавления в корзину с подтверждением
function addToCart(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    appData.pendingProduct = product;
    
    // Если у товара есть выбор цвета
    if (product.colors && product.colors.length > 0) {
        showColorSelector(product);
    } else {
        // Показываем подтверждение
        showConfirm(
            '🛒',
            'Добавить в корзину?',
            `Вы хотите добавить "${product.name}" в корзину?`,
            () => {
                addProductToCart(product);
                showNotification(`${product.name} добавлен в корзину`);
            },
            () => {}
        );
    }
}

// Показ выбора цвета
function showColorSelector(product) {
    const modal = document.getElementById('colorSelectorModal');
    document.getElementById('colorSelectorTitle').textContent = `Выберите цвет ${product.name}`;
    document.getElementById('colorPreviewImage').src = product.image;
    
    const colorGrid = document.getElementById('colorGrid');
    colorGrid.innerHTML = '';
    
    product.colors.forEach((color, index) => {
        const colorOption = document.createElement('div');
        colorOption.className = 'color-option';
        if (index === 0) {
            colorOption.classList.add('selected');
            appData.selectedColor = color;
        }
        
        colorOption.innerHTML = `
            <div class="color-option-inner" style="background: ${color.color}"></div>
            <div class="color-name">${color.name}</div>
        `;
        
        colorOption.onclick = () => {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            colorOption.classList.add('selected');
            appData.selectedColor = color;
            document.getElementById('colorPreviewImage').src = color.image;
        };
        
        colorGrid.appendChild(colorOption);
    });
    
    modal.classList.add('active');
}

// Подтверждение выбора цвета
document.getElementById('colorConfirmBtn').addEventListener('click', () => {
    const modal = document.getElementById('colorSelectorModal');
    modal.classList.remove('active');
    
    if (appData.pendingProduct && appData.selectedColor) {
        const productWithColor = {
            ...appData.pendingProduct,
            selectedColor: appData.selectedColor,
            image: appData.selectedColor.image,
            displayName: `${appData.pendingProduct.name} (${appData.selectedColor.name})`
        };
        
        addProductToCart(productWithColor);
        showNotification(`${productWithColor.displayName} добавлен в корзину`);
    }
});

// Добавление товара в корзину
function addProductToCart(product) {
    const cartItem = appData.cart.find(item => {
        if (product.selectedColor) {
            return item.id === product.id && 
                   item.selectedColor?.name === product.selectedColor.name;
        }
        return item.id === product.id;
    });
    
    if (cartItem) {
        cartItem.quantity++;
    } else {
        appData.cart.push({ 
            ...product, 
            quantity: 1,
            cartId: Date.now() // Уникальный ID для корзины
        });
    }
    
    updateBadges();
}

// Функция переключения избранного
function toggleFavorite(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    const index = appData.favorites.findIndex(f => f.id === productId);
    if (index > -1) {
        appData.favorites.splice(index, 1);
    } else {
        appData.favorites.push(product);
    }
    
    saveAppData(); // Сохраняем при изменении избранного
    displayProducts();
    updateBadges();
}

// Управление таблицей категорий
const categoriesToggle = document.getElementById('categoriesToggle');
const categoriesPanel = document.getElementById('categoriesPanel');

categoriesToggle.addEventListener('click', function() {
    this.classList.toggle('active');
    categoriesPanel.classList.toggle('active');
});

// Выбор категории
document.querySelectorAll('.category-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        
        appData.currentCategory = this.dataset.category;
        const categoryName = this.querySelector('.category-name').textContent;
        document.getElementById('currentCategory').textContent = categoryName;
        
        displayProducts();
        
        // Закрываем панель после выбора
        setTimeout(() => {
            categoriesToggle.classList.remove('active');
            categoriesPanel.classList.remove('active');
        }, 300);
    });
});

// Выбор темы
document.querySelectorAll('.theme-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        appData.theme = this.dataset.theme;
        
        // Применяем тему к фону и документу
        const setupContainer = document.getElementById('setupContainer');
        if (appData.theme === 'dark') {
            document.body.classList.add('dark-theme');
            setupContainer.classList.add('dark-theme');
            setupContainer.classList.remove('light-theme');
        } else {
            document.body.classList.remove('dark-theme');
            setupContainer.classList.add('light-theme');
            setupContainer.classList.remove('dark-theme');
        }
        
        document.getElementById('themeNextBtn').classList.add('active');
    });
});

document.getElementById('themeNextBtn').addEventListener('click', function() {
    if (!appData.theme) return;
    document.getElementById('themePage').classList.remove('active');
    document.getElementById('cityPage').classList.add('active');
});

// Выбор города
document.querySelectorAll('.city-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.city-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        appData.city = this.dataset.city;
        document.getElementById('cityNextBtn').classList.add('active');
    });
});

document.getElementById('cityNextBtn').addEventListener('click', function() {
    if (!appData.city) return;
    saveAppData();
    document.getElementById('setupContainer').style.display = 'none';
    document.getElementById('appContainer').classList.add('active');
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('catalogPage').style.display = 'block';
    initCatalog();
});
function fillTestData() {
    document.getElementById('fullName').value = 'Иванов Иван Иванович';
    document.getElementById('phone').value = '+375291234567';
    document.getElementById('telegram').value = '@username';
    document.getElementById('meetTime').value = '15:00';
    validateContacts();
}
// Инициализация каталога
function initCatalog() {
    displayProducts();
    updateBadges();
    updateCategoryCounters();
}

// Отображение товаров
function displayProducts() {
    const grid = document.getElementById('productsGrid');
    let productsToShow = appData.currentCategory === 'all' 
        ? allProducts 
        : products[appData.currentCategory] || [];
    
    // Фильтрация по цене
    productsToShow = productsToShow.filter(p => 
        p.price >= appData.priceFilter.from && p.price <= appData.priceFilter.to
    );
    
    // Сортировка
    if (appData.sortType === 'cheap') {
        productsToShow.sort((a, b) => a.price - b.price);
    } else if (appData.sortType === 'expensive') {
        productsToShow.sort((a, b) => b.price - a.price);
    }
    
    grid.innerHTML = '';
    productsToShow.forEach(product => {
        const isFavorite = appData.favorites.some(f => f.id === product.id);
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
            <img src="${product.image}" alt="${product.name}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div>
                    <span class="product-price">${product.price} BYN</span>
                    ${product.oldPrice ? `<span class="product-old-price">${product.oldPrice} BYN</span>` : ''}
                </div>
                <div class="product-actions">
                    <button class="add-to-cart-btn" onclick="addToCart(${product.id})">В корзину</button>
                    <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${product.id})">
                        ${isFavorite ? '❤️' : '🤍'}
                    </button>
                    <button class="action-btn info-btn" onclick="showProductModal(${product.id})">ℹ️</button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}
function autoFocusEmptyField() {
    const fields = ['setupFullName', 'setupPhone', 'setupTelegram'];
    for (let fieldId of fields) {
        const field = document.getElementById(fieldId);
        if (field && !field.value) {
            field.focus();
            break;
        }
    }
}
function showProductModal(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    appData.currentProductModal = product;
    
    document.getElementById('modalImage').src = product.image;
    document.getElementById('modalTitle').textContent = product.name;
    document.getElementById('modalPrice').textContent = `${product.price} BYN`;
    document.getElementById('modalDescription').textContent = product.description || 'Описание товара отсутствует';
    
    const specsList = document.getElementById('modalSpecs');
    specsList.innerHTML = '';
    if (product.specs) {
        Object.entries(product.specs).forEach(([key, value]) => {
            const li = document.createElement('li');
            li.className = 'detail-item';
            li.innerHTML = `
                <span class="detail-label">${key}:</span>
                <span class="detail-value">${value}</span>
            `;
            specsList.appendChild(li);
        });
    }
    
    document.getElementById('productModal').classList.add('active');
}

function closeProductModal() {
    document.getElementById('productModal').classList.remove('active');
    appData.currentProductModal = null;
}

function toggleCollapsible(element) {
    const section = element.parentElement;
    const content = section.querySelector('.collapsible-content');
    const arrow = element.querySelector('.collapsible-arrow');
    
    section.classList.toggle('active');
    
    if (section.classList.contains('active')) {
        content.style.maxHeight = content.scrollHeight + 'px';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.style.maxHeight = '0';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function addToCartFromModal() {
    if (appData.currentProductModal) {
        addToCart(appData.currentProductModal.id);
        closeProductModal();
    }
}

document.getElementById('userDataPage')?.addEventListener('show', autoFocusEmptyField);
document.getElementById('searchInput').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    if (query) {
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(query)
        );
        displayFilteredProducts(filtered);
    } else {
        displayProducts();
    }
});

function displayFilteredProducts(productsToShow) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';
    productsToShow.forEach(product => {
        const isFavorite = appData.favorites.some(f => f.id === product.id);
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
            <img src="${product.image}" alt="${product.name}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div>
                    <span class="product-price">${product.price} BYN</span>
                    ${product.oldPrice ? `<span class="product-old-price">${product.oldPrice} BYN</span>` : ''}
                </div>
                <div class="product-actions">
                    <button class="add-to-cart-btn" onclick="addToCart(${product.id})">В корзину</button>
                    <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(${product.id})">
                        ${isFavorite ? '❤️' : '🤍'}
                    </button>
                    <button class="action-btn info-btn" onclick="showProductModal(${product.id})">ℹ️</button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Сортировка
document.getElementById('sortBtn').addEventListener('click', function() {
    document.getElementById('sortOverlay').classList.add('active');
    document.getElementById('sortSheet').classList.add('active');
});

document.getElementById('sortOverlay').addEventListener('click', function() {
    this.classList.remove('active');
    document.getElementById('sortSheet').classList.remove('active');
    document.getElementById('filterSheet').classList.remove('active');
});

document.querySelectorAll('.sort-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.sort-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        appData.sortType = this.dataset.sort;
    });
});

document.getElementById('applySortBtn').addEventListener('click', function() {
    displayProducts();
    document.getElementById('sortOverlay').classList.remove('active');
    document.getElementById('sortSheet').classList.remove('active');
});

// Фильтры
document.getElementById('filterBtn').addEventListener('click', function() {
    const range = getPriceRange();
    document.getElementById('priceFrom').placeholder = range.min;
    document.getElementById('priceTo').placeholder = range.max;
    document.getElementById('priceTo').value = range.max;
    
    document.getElementById('sortOverlay').classList.add('active');
    document.getElementById('filterSheet').classList.add('active');
});

document.getElementById('applyFilterBtn').addEventListener('click', function() {
    appData.priceFilter.from = parseInt(document.getElementById('priceFrom').value) || 0;
    appData.priceFilter.to = parseInt(document.getElementById('priceTo').value) || 1000;
    displayProducts();
    document.getElementById('sortOverlay').classList.remove('active');
    document.getElementById('filterSheet').classList.remove('active');
    updateFilterIndicators();
});

// Нижняя навигация
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
        const page = this.dataset.page;
        
        if (page === 'search') {
            document.getElementById('fullscreenSearch').classList.add('active');
            document.getElementById('fullSearchInput').focus();
            return;
        }
        
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');
        
        // Скрыть все страницы
        document.getElementById('catalogPage').style.display = 'none';
        document.getElementById('favoritesPage').classList.remove('active');
        document.getElementById('cartPage').classList.remove('active');
        document.getElementById('profilePage').classList.remove('active');
        
        // Показать нужную
        if (page === 'catalog') {
            document.getElementById('catalogPage').style.display = 'block';
        } else if (page === 'favorites') {
            document.getElementById('favoritesPage').classList.add('active');
            renderFavorites();
        } else if (page === 'cart') {
            document.getElementById('cartPage').classList.add('active');
            renderCart();
        } else if (page === 'profile') {
            document.getElementById('profilePage').classList.add('active');
            updateProfile();
        }
    });
});

document.getElementById('searchBackBtn').addEventListener('click', function() {
    document.getElementById('fullscreenSearch').classList.remove('active');
    document.getElementById('fullSearchInput').value = ''; // Очищаем поиск
    document.getElementById('searchResults').innerHTML = ''; // Очищаем результаты
});
document.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => vibrate());
});
document.getElementById('fullSearchInput').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const results = document.getElementById('searchResults');
    
    if (query) {
        const filtered = allProducts.filter(p => 
            p.name.toLowerCase().includes(query)
        );
        
        results.innerHTML = '';
        filtered.forEach(product => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = `
                <img src="${product.image}" class="search-result-image">
                <div class="search-result-info">
                    <div class="search-result-name">${product.name}</div>
                    <div class="search-result-price">${product.price} BYN</div>
                </div>
            `;
            item.onclick = () => {
                showProductModal(product.id);
            };
            results.appendChild(item);
        });
    } else {
        results.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px;">Начните вводить название товара</p>';
    }
});
function updateFilterIndicators() {
    const filterBtn = document.getElementById('filterBtn');
    const sortBtn = document.getElementById('sortBtn');
    
    // Проверяем активны ли фильтры
    const prices = allProducts.map(p => p.price);
    const isFiltered = appData.priceFilter.from > Math.min(...prices) || 
                      appData.priceFilter.to < Math.max(...prices);
    
    const isSorted = appData.sortType !== 'default';
    
    // Добавляем индикаторы
    if (isFiltered) {
        filterBtn.classList.add('has-active');
        filterBtn.innerHTML = '⚙️<span class="indicator-dot"></span>';
    } else {
        filterBtn.classList.remove('has-active');
        filterBtn.innerHTML = '⚙️';
    }
    
    if (isSorted) {
        sortBtn.classList.add('has-active');
    } else {
        sortBtn.classList.remove('has-active');
    }
}

function vibrate(duration = 10) {
    if (navigator.vibrate) {
        navigator.vibrate(duration);
    }
}
function updateBadges() {
    const cartCount = appData.cart.reduce((sum, item) => sum + item.quantity, 0);
    const favCount = appData.favorites.length;
    
    const cartBadge = document.getElementById('cartBadge');
    const favBadge = document.getElementById('favBadge');
    
    if (cartBadge) {
        if (cartCount > 0) {
            cartBadge.textContent = cartCount;
            cartBadge.style.display = 'block';
        } else {
            cartBadge.style.display = 'none';
        }
    }
    
    if (favBadge) {
        if (favCount > 0) {
            favBadge.textContent = favCount;
            favBadge.style.display = 'block';
        } else {
            favBadge.style.display = 'none';
        }
    }
}

// Рендер избранного
function renderFavorites() {
    const content = document.getElementById('favoritesContent');
    if (appData.favorites.length === 0) {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">❤️</div>
                <div class="empty-title">Нет избранных товаров</div>
                <div class="empty-text">Добавляйте товары в избранное, чтобы быстро найти их позже</div>
            </div>
        `;
    } else {
        content.innerHTML = '<div class="products-grid">' + 
            appData.favorites.map(product => `
                <div class="product-card">
                    ${product.badge ? `<div class="product-badge">${product.badge}</div>` : ''}
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div>
                            <span class="product-price">${product.price} BYN</span>
                            ${product.oldPrice ? `<span class="product-old-price">${product.oldPrice} BYN</span>` : ''}
                        </div>
                        <div class="product-actions">
                            <button class="add-to-cart-btn" onclick="addToCart(${product.id})">В корзину</button>
                            <button class="action-btn favorite-btn active" onclick="toggleFavorite(${product.id}); renderFavorites();">❤️</button>
                            <button class="action-btn info-btn" onclick="showProductModal(${product.id})">ℹ️</button>
                        </div>
                    </div>
                </div>
            `).join('') + '</div>';
    }
}

// Рендер корзины
function renderCart() {
    const content = document.getElementById('cartContent');
    if (appData.cart.length === 0) {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">🛒</div>
                <div class="empty-title">Корзина пуста</div>
                <div class="empty-text">Добавьте товары из каталога</div>
            </div>
        `;
    } else {
        const total = appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        content.innerHTML = appData.cart.map(item => `
            <div class="cart-item">
                <img src="${item.image}" class="cart-item-image">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.displayName || item.name}</div>
                    <div class="cart-item-price">${item.price} BYN</div>
                </div>
                <div class="cart-quantity">
                    <button class="quantity-btn" onclick="changeQuantity(${item.cartId || item.id}, -1)">−</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn" onclick="changeQuantity(${item.cartId || item.id}, 1)">+</button>
                </div>
            </div>
        `).join('') + `
            <div style="padding: 20px; margin-top: 20px; background: var(--bg-gray); border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700;">
                    <span>Итого:</span>
                    <span style="color: var(--primary);">${total} BYN</span>
                </div>
                <button class="apply-btn" style="margin-top: 15px;" onclick="startCheckout()">Оформить заказ</button>
            </div>
        `;
    }
}
function sendMessageToUser(chatId, message, orderNumber) {
    const BOT_TOKEN = '7465560270:AAGHr8lRxYVJjgQzOdQmOKQxXi7qhVoF2ak'; // Замените на ваш токен
    
    // Кнопки для сообщения
    const keyboard = {
        inline_keyboard: [
            [
                { text: '💬 Связаться с продавцом', url: 'https://t.me/ZHIZHA_BOSS' }
            ],
            [
                { text: '❌ Отменить заказ', callback_data: `cancel_${orderNumber}` }
            ]
        ]
    };
    
    // Отправляем через Telegram Bot API
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: chatId,
            text: message,
            parse_mode: 'HTML',
            reply_markup: keyboard
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            console.log('Сообщение отправлено');
        } else {
            console.error('Ошибка отправки:', data);
            // Fallback - используем sendData
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify({
                    orderNumber: orderNumber,
                    message: message
                }));
            }
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
    });
}

// Отправка уведомления админу
function sendOrderToAdmin(orderNumber, total) {
    const BOT_TOKEN = '8326635737:AAHvbr2NDX72ZsdSRpvAU0ToO4LJnNu1a2M'; // Ваш токен
    const ADMIN_ID = '6759774187'; // ID админа (замените на ваш)
    
    let adminMessage = `🆕 <b>НОВЫЙ ЗАКАЗ #${orderNumber}</b>\n\n`;
    adminMessage += `👤 Клиент: ${appData.order.contact.fullName}\n`;
    adminMessage += `📱 Телефон: ${appData.order.contact.phone}\n`;
    adminMessage += `💬 Telegram: ${appData.order.contact.telegram}\n`;
    adminMessage += `💰 Сумма: ${total} BYN\n`;
    adminMessage += `📍 Место: ${appData.order.location}\n`;
    adminMessage += `⏰ Время: ${appData.order.contact.meetTime}`;
    
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: ADMIN_ID,
            text: adminMessage,
            parse_mode: 'HTML'
        })
    });
}
function confirmOrder() {
    // Генерируем номер заказа
    const orderNumber = Math.floor(10000 + Math.random() * 90000);
    
    // Подготавливаем данные
    const cartTotal = appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const deliveryCost = appData.order.delivery === 'minsk' ? 0 : 
                        appData.order.delivery === 'address' ? 3 : 2;
    const total = cartTotal + deliveryCost;
    
    // ВАЖНО: Формируем объект для отправки боту
    const orderData = {
        type: 'order', // Тип сообщения
        orderNumber: orderNumber,
        customer: {
            name: appData.order.contact.fullName,
            phone: appData.order.contact.phone,
            telegram: appData.order.contact.telegram
        },
        delivery: {
            location: appData.order.location,
            time: appData.order.contact.meetTime,
            cost: deliveryCost
        },
        payment: appData.order.payment,
        items: appData.cart.map(item => ({
            name: item.displayName || item.name,
            quantity: item.quantity,
            price: item.price
        })),
        total: total
    };
    
    // Показываем успех
    document.getElementById('orderNumber').textContent = `Заказ #${orderNumber}`;
    showCheckoutPage('successPage');
    
    // ОТПРАВЛЯЕМ ДАННЫЕ БОТУ
    if (window.Telegram && window.Telegram.WebApp) {
        try {
            // Отправляем данные и закрываем приложение
            window.Telegram.WebApp.sendData(JSON.stringify(orderData));
            
            // Показываем уведомление
            showNotification('✅ Заказ отправлен! Проверьте чат с ботом');
            
            // Закрываем приложение через 2 секунды
            setTimeout(() => {
                window.Telegram.WebApp.close();
            }, 2000);
            
        } catch (error) {
            console.error('Ошибка отправки:', error);
            alert('Ошибка отправки заказа');
        }
    } else {
        // Для тестирования в браузере
        console.log('Данные заказа:', orderData);
        alert('Заказ создан (тестовый режим):\n' + JSON.stringify(orderData, null, 2));
    }
    
    // Очищаем корзину
    appData.cart = [];
    updateBadges();
}
async function sendSimpleNotification(orderNumber) {
    // Конфигурация бота
    const BOT_TOKEN = '8326635737:AAHvbr2NDX72ZsdSRpvAU0ToO4LJnNu1a2M'; // Ваш токен
    
    // Получаем ID пользователя
    const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    
    if (!userId) {
        console.log('ID пользователя не найден');
        return;
    }
    
    // Простое сообщение
    const message = `✅ Заказ #${orderNumber} успешно создан!\n\n📍 Будьте на месте встречи!`;
    
    // Отправляем через Telegram Bot API
    try {
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: userId,
                text: message,
                parse_mode: 'HTML'
            })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            console.log('✅ Уведомление отправлено пользователю');
        } else {
            console.error('Ошибка отправки:', data.description);
            
            // Если не удалось отправить - показываем в приложении
            showNotification('📱 Откройте чат с ботом для получения уведомлений');
        }
    } catch (error) {
        console.error('Ошибка:', error);
    }
}

// Отправка детальной информации админу
async function sendOrderToAdmin(orderData) {
    const BOT_TOKEN = '8326635737:AAHvbr2NDX72ZsdSRpvAU0ToO4LJnNu1a2M';
    const ADMIN_ID = '6759774187'; // Ваш ID
    
    let adminMessage = `🆕 <b>НОВЫЙ ЗАКАЗ #${orderData.orderNumber}</b>\n\n`;
    adminMessage += `👤 Клиент: ${orderData.contact.fullName}\n`;
    adminMessage += `📱 Телефон: ${orderData.contact.phone}\n`;
    adminMessage += `💬 Telegram: ${orderData.contact.telegram}\n`;
    adminMessage += `💰 Сумма: ${orderData.total} BYN\n`;
    adminMessage += `📍 Место: ${orderData.location}\n`;
    adminMessage += `⏰ Время: ${orderData.time}\n\n`;
    
    adminMessage += `<b>Товары:</b>\n`;
    orderData.items.forEach(item => {
        adminMessage += `• ${item.displayName || item.name} x${item.quantity}\n`;
    });
    
    try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: ADMIN_ID,
                text: adminMessage,
                parse_mode: 'HTML'
            })
        });
        console.log('✅ Уведомление отправлено админу');
    } catch (error) {
        console.error('Ошибка отправки админу:', error);
    }
}
function changeQuantity(cartId, change) {
    const item = appData.cart.find(i => (i.cartId || i.id) === cartId);
    if (!item) return;
    
    item.quantity += change;
    if (item.quantity <= 0) {
        appData.cart = appData.cart.filter(i => (i.cartId || i.id) !== cartId);
    }
    
    renderCart();
    updateBadges();
    
    // Обновляем профиль если он открыт
    if (document.getElementById('profilePage').classList.contains('active')) {
        updateProfile();
    }
}
// Обновление профиля
function updateProfile() {
    const cartCount = appData.cart.reduce((sum, item) => sum + item.quantity, 0);
    const favCount = appData.favorites.length;
    const totalAmount = appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    
    document.getElementById('cartCount').textContent = cartCount;
    document.getElementById('favCount').textContent = favCount;
    document.getElementById('totalAmount').textContent = `${totalAmount} BYN`;
    
    if (document.getElementById('darkModeToggle')) {
        document.getElementById('darkModeToggle').checked = appData.theme === 'dark';
    }
    if (tg && tg.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        document.getElementById('profileName').textContent = 
            user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('profileAvatar').textContent = 
            user.first_name[0].toUpperCase();
        document.getElementById('profileId').textContent = user.id;
    }
    if (appData.themeColor) {
        document.querySelectorAll('.theme-color-option').forEach(opt => {
            opt.classList.remove('active');
        });
        document.querySelector(`.theme-color-option[data-color="${appData.themeColor}"]`)?.classList.add('active');
    }
}
function changeThemeColor(color) {
    // Применяем цвет
    document.body.setAttribute('data-theme', color);
    appData.themeColor = color;
    
    // Для черной темы автоматически включаем темный режим
    if (color === 'black') {
        document.body.classList.add('dark-theme');
        appData.theme = 'dark';
        if (document.getElementById('darkModeToggle')) {
            document.getElementById('darkModeToggle').checked = true;
        }
    }
    // Для белой темы отключаем темный режим
    else if (color === 'white') {
        document.body.classList.remove('dark-theme');
        appData.theme = 'light';
        if (document.getElementById('darkModeToggle')) {
            document.getElementById('darkModeToggle').checked = false;
        }
    }
    
    // Обновляем активную кнопку
    document.querySelectorAll('.theme-color-option').forEach(opt => {
        opt.classList.remove('active');
    });
    document.querySelector(`.theme-color-option[data-color="${color}"]`)?.classList.add('active');
    
    // Анимация изменения фона
    document.body.style.transition = 'all 0.5s ease';
    setTimeout(() => {
        document.body.style.transition = '';
    }, 500);
    
    // Сохраняем
    saveAppData();
    
    // Показываем уведомление
    showNotification('Цвет интерфейса изменен! 🎨');
}

// Функция переключения темной темы
function toggleDarkMode() {
    const isDark = document.getElementById('darkModeToggle').checked;
    if (isDark) {
        document.body.classList.add('dark-theme');
        appData.theme = 'dark';
    } else {
        document.body.classList.remove('dark-theme');
        appData.theme = 'light';
    }
    
    // Анимация
    document.body.style.transition = 'all 0.5s ease';
    setTimeout(() => {
        document.body.style.transition = '';
    }, 500);
    
    saveAppData();
    showNotification(isDark ? 'Темная тема включена 🌙' : 'Светлая тема включена ☀️');
}


// Оформление заказа
function startCheckout() {
    if (appData.cart.length === 0) return;
    
    // Сброс данных заказа
    appData.order = {
        delivery: null,
        location: null,
        payment: null,
        contact: {}
    };
    
    // Показываем первый шаг
    document.getElementById('checkoutContainer').classList.add('active');
    showCheckoutPage('deliveryPage');
}

function showCheckoutPage(pageId) {
    console.log('Показываем страницу:', pageId); // Для отладки
    
    // Скрываем все страницы checkout
    document.querySelectorAll('.checkout-page').forEach(page => {
        page.classList.remove('active');
        page.style.display = 'none';
    });
    
    // Показываем нужную страницу
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
        targetPage.style.display = 'block';
        console.log('Страница найдена и показана'); // Для отладки
    } else {
        console.error('Страница не найдена:', pageId);
        // Fallback - показываем страницу контактов
        const contactsPage = document.getElementById('contactsPage');
        if (contactsPage) {
            contactsPage.classList.add('active');
            contactsPage.style.display = 'block';
        }
    }
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Закрываем все активные модалки
        document.querySelectorAll('.product-modal.active, .confirm-modal.active, .color-selector-modal.active').forEach(modal => {
            modal.classList.remove('active');
        });
        
        // Закрываем поиск
        if (document.getElementById('fullscreenSearch').classList.contains('active')) {
            document.getElementById('fullscreenSearch').classList.remove('active');
        }
        
        // Закрываем checkout
        if (document.getElementById('checkoutContainer').classList.contains('active')) {
            showConfirm('⚠️', 'Отменить оформление?', 'Ваш заказ не будет сохранен', 
                () => closeCheckout(), 
                () => {}
            );
        }
    }
});
document.querySelectorAll('.delivery-option').forEach(option => {
    option.addEventListener('click', function() {
        // Если выбираем другой тип доставки, сбрасываем location
        if (appData.order.delivery !== this.dataset.delivery) {
            appData.order.location = null;
            document.getElementById('deliveryNextBtn').disabled = true;
        }
        
        document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        appData.order.delivery = this.dataset.delivery;
    });
});
function getPriceRange() {
    const prices = allProducts.map(p => p.price);
    return {
        min: Math.min(...prices),
        max: Math.max(...prices)
    };
}

function openLocationModal(type) {
    const modal = document.getElementById('locationModal');
    const content = document.getElementById('locationContent');
    
    if (type === 'minsk') {
        content.innerHTML = `
            <div class="location-list">
                <div class="location-item" onclick="selectLocation('г. Молодечно, ул. Ларина 4А')">
                    г. Молодечно, ул. Ларина 4А
                </div>
                <div class="location-item" onclick="selectLocation('Вокзал станции Молодечно')">
                    Вокзал станции Молодечно
                </div>
            </div>
        `;
    } else if (type === 'address') {
        content.innerHTML = `
            <div class="address-input-container">
                <input type="text" class="address-input" id="addressInput" placeholder="Введите адрес доставки...">
                <button class="confirm-location-btn" onclick="confirmAddress()">Подтвердить адрес</button>
            </div>
        `;
    } else if (type === 'krasnoe') {
        content.innerHTML = `
            <div class="location-list">
                <div class="location-item" onclick="selectLocation('Железнодорожная Станция Уша')">
                    Железнодорожная Станция Уша
                </div>
            </div>
        `;
    }
    
    modal.classList.add('active');
}

function closeLocationModal() {
    document.getElementById('locationModal').classList.remove('active');
}

function selectLocation(location) {
    appData.order.location = location;
    document.getElementById('deliveryNextBtn').disabled = false;
    closeLocationModal();
}

function confirmAddress() {
    const address = document.getElementById('addressInput').value;
    if (address.trim()) {
        appData.order.location = address;
        document.getElementById('deliveryNextBtn').disabled = false;
        closeLocationModal();
    }
}

function goToPayment() {
    if (!appData.order.location) return;
    showCheckoutPage('paymentPage');
}

// Выбор оплаты
document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        appData.order.payment = this.dataset.payment;
        document.getElementById('paymentNextBtn').disabled = false;
    });
});

function goToContacts() {
    if (!appData.order.payment) return;
    
    // Проверяем есть ли сохраненные данные
    if (appData.userData && appData.userData.saved) {
        // Если данные есть - показываем упрощенную форму
        // Заполняем данные в упрощенной форме
        if (document.getElementById('checkoutName')) {
            document.getElementById('checkoutName').textContent = appData.userData.fullName;
            document.getElementById('checkoutPhone').textContent = appData.userData.phone;
            document.getElementById('checkoutTelegram').textContent = appData.userData.telegram;
        }
        
        // Проверяем существует ли упрощенная страница
        const simplePage = document.getElementById('contactsPageSimple');
        if (simplePage) {
            showCheckoutPage('contactsPageSimple');
        } else {
            // Если упрощенной страницы нет - показываем обычную
            showCheckoutPage('contactsPage');
            // Автозаполняем поля
            if (appData.userData) {
                document.getElementById('fullName').value = appData.userData.fullName || '';
                document.getElementById('phone').value = appData.userData.phone || '';
                document.getElementById('telegram').value = appData.userData.telegram || '';
            }
        }
    } else {
        // Если данных нет - показываем полную форму
        showCheckoutPage('contactsPage');
    }
}

// Валидация контактов
function validateContacts() {
    const fullName = document.getElementById('fullName').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const telegram = document.getElementById('telegram').value.trim();
    const meetTime = document.getElementById('meetTime').value.trim();
    
    let isValid = true;
    
    // Проверка ФИО (минимум 3 символа)
    if (fullName.length < 3) {
        document.getElementById('fullName').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('fullName').classList.remove('error');
    }
    
    // Проверка телефона 
    const phoneDigits = phone.replace(/\D/g, '');
    if (!phone.startsWith('+375') || phoneDigits.length !== 12) {
        document.getElementById('phone').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('phone').classList.remove('error');
    }
    
    // Проверка Telegram
    if (!telegram.startsWith('@') || telegram.length < 5) {
        document.getElementById('telegram').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('telegram').classList.remove('error');
    }
    
    // Проверка времени
    if (meetTime.length < 3) {
        document.getElementById('meetTime').classList.add('error');
        isValid = false;
    } else {
        document.getElementById('meetTime').classList.remove('error');
    }
    
    // ВАЖНО: Убираем disabled если валидация прошла
    const nextBtn = document.getElementById('contactsNextBtn');
    if (nextBtn) {
        if (isValid) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
    }
    
    return isValid;
}
document.getElementById('contactsNextBtn').addEventListener('click', function() {
    goToSummary();
});
document.getElementById('phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    // Если начинается не с 375, добавляем
    if (!value.startsWith('375')) {
        if (value.startsWith('8')) {
            value = '375' + value.substring(1);
        } else if (!value) {
            value = '375';
        }
    }
    
    // Ограничиваем длину
    if (value.length > 12) {
        value = value.substring(0, 12);
    }
    
    // Добавляем +
    if (value.length > 0) {
        e.target.value = '+' + value;
    }
    
    validateContacts();
});

// Автоформатирование времени
document.getElementById('meetTime').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d:]/g, '');
    
    // Автоматически добавляем двоеточие после двух цифр
    if (value.length === 2 && !value.includes(':')) {
        value = value + ':';
    }
    
    e.target.value = value;
    validateContacts();
});

// Автоформатирование Telegram
document.getElementById('telegram').addEventListener('input', function(e) {
    let value = e.target.value;
    
    // Если не начинается с @, добавляем
    if (!value.startsWith('@') && value.length > 0) {
        value = '@' + value.replace('@', '');
    }
    
    // Убираем пробелы
    value = value.replace(/\s/g, '');
    
    e.target.value = value;
    validateContacts();
});
document.getElementById('fullName').addEventListener('input', validateContacts);
document.getElementById('phone').addEventListener('input', validateContacts);
document.getElementById('telegram').addEventListener('input', validateContacts);
document.getElementById('meetTime').addEventListener('input', validateContacts);

function goToSummary() {
    // Проверяем валидацию еще раз
    if (!validateContacts()) {
        showNotification('Заполните все обязательные поля! ⚠️');
        return;
    }
    
    // Сохраняем контактные данные
    appData.order.contact = {
        fullName: document.getElementById('fullName').value,
        phone: document.getElementById('phone').value,
        telegram: document.getElementById('telegram').value,
        meetTime: document.getElementById('meetTime').value,
        comment: document.getElementById('comment')?.value || ''
    };
    
    // Формируем сводку заказа
    const cartTotal = appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const deliveryCost = appData.order.delivery === 'minsk' ? 0 : 
                        appData.order.delivery === 'address' ? 3 : 2;
    const total = cartTotal + deliveryCost;
    
    const summary = document.getElementById('orderSummary');
    if (!summary) {
        console.error('orderSummary element not found');
        showNotification('Ошибка загрузки страницы');
        return;
    }
    
    // Формируем HTML сводки
    summary.innerHTML = `
        <div class="summary-item">
            <span>Товары:</span>
            <span>${appData.cart.length} позиций</span>
        </div>
        <div class="summary-item">
            <span>Стоимость товаров:</span>
            <span>${cartTotal} BYN</span>
        </div>
        <div class="summary-item">
            <span>Способ доставки:</span>
            <span>${appData.order.delivery === 'minsk' ? 'Минск' : 
                    appData.order.delivery === 'address' ? 'На адрес' : 'Красное'}</span>
        </div>
        <div class="summary-item">
            <span>Место встречи:</span>
            <span style="font-size: 12px;">${appData.order.location || 'Не указано'}</span>
        </div>
        <div class="summary-item">
            <span>Стоимость доставки:</span>
            <span>${deliveryCost} BYN</span>
        </div>
        <div class="summary-item">
            <span>Способ оплаты:</span>
            <span>${appData.order.payment === 'cash' ? 'Наличные' : 'Перевод на карту'}</span>
        </div>
        <div class="summary-item">
            <span>Телефон:</span>
            <span>${appData.order.contact.phone}</span>
        </div>
        <div class="summary-item">
            <span>ФИО:</span>
            <span>${appData.order.contact.fullName}</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-total">
            <span>Всего к оплате:</span>
            <span>${total} BYN</span>
        </div>
    `;
    
    // Переходим на страницу подтверждения
    showCheckoutPage('summaryPage');
}

function confirmOrder() {
    // Генерируем номер заказа
    const orderNumber = Math.floor(10000 + Math.random() * 90000);
    document.getElementById('orderNumber').textContent = `Заказ #${orderNumber}`;
    
    if (!appData.userData || !appData.userData.saved) {
        appData.userData = {
            fullName: appData.order.contact.fullName,
            phone: appData.order.contact.phone,
            telegram: appData.order.contact.telegram,
            saved: true // Отмечаем что данные сохранены
        };
        saveAppData();
        console.log('Данные пользователя сохранены после первого заказа');
    }
    if (tg) {
        const orderData = {
            orderNumber,
            ...appData.order,
            cart: appData.cart,
            total: appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0)
        };
        tg.sendData(JSON.stringify(orderData));
    }
        const cartTotal = appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const deliveryCost = appData.order.delivery === 'minsk' ? 0 : 
                        appData.order.delivery === 'address' ? 3 : 2;
    const total = cartTotal + deliveryCost;
    
    // Формируем объект заказа для бота
    const orderData = {
        type: 'order', // Тип сообщения для бота
        orderId: orderNumber,
        user: {
            fullName: appData.order.contact.fullName,
            phone: appData.order.contact.phone,
            telegram: appData.order.contact.telegram
        },
        delivery: {
            method: appData.order.delivery,
            location: appData.order.location,
            time: appData.order.contact.meetTime,
            cost: deliveryCost
        },
        payment: appData.order.payment === 'cash' ? 'Наличные' : 'Карта',
        items: appData.cart.map(item => ({
            name: item.displayName || item.name,
            color: item.selectedColor?.name || 'Без выбора',
            quantity: item.quantity,
            price: item.price,
            total: item.price * item.quantity
        })),
        totals: {
            products: cartTotal,
            delivery: deliveryCost,
            total: total
        },
        comment: appData.order.contact.comment || ''
    };
    
    // Отправляем данные в бот
    if (window.Telegram && window.Telegram.WebApp) {
        try {
            // Отправляем данные боту
            window.Telegram.WebApp.sendData(JSON.stringify(orderData));
            
            // Показываем успешную страницу
            document.getElementById('orderNumber').textContent = `Заказ #${orderNumber}`;
            showCheckoutPage('successPage');
            
            // Очищаем корзину
            appData.cart = [];
            updateBadges();
            
        } catch (error) {
            console.error('Ошибка отправки заказа:', error);
            showNotification('Ошибка отправки заказа ❌');
        }
    } else {
        // Для тестирования без Telegram
        console.log('Order Data:', orderData);
        alert('Заказ создан (тестовый режим):\n' + JSON.stringify(orderData, null, 2));
        
        document.getElementById('orderNumber').textContent = `Заказ #${orderNumber}`;
        showCheckoutPage('successPage');
        appData.cart = [];
        updateBadges();
    }
    
    // Очищаем корзину
    appData.cart = [];
    updateBadges();
    
    showCheckoutPage('successPage');
}
function contactSeller() {
    if (window.Telegram && window.Telegram.WebApp) {
        // Отправляем команду боту для связи с продавцом
        const contactData = {
            type: 'contact_seller',
            orderId: document.getElementById('orderNumber').textContent
        };
        window.Telegram.WebApp.sendData(JSON.stringify(contactData));
        window.Telegram.WebApp.close();
    } else {
        // Для тестирования
        window.open('https://t.me/ZHIZHA_BOSS', '_blank');
    }
}

// Отмена заказа
function cancelOrder() {
    showConfirm(
        '⚠️',
        'Отменить заказ?',
        'Вы уверены, что хотите отменить заказ?',
        () => {
            if (window.Telegram && window.Telegram.WebApp) {
                const cancelData = {
                    type: 'cancel_order',
                    orderId: document.getElementById('orderNumber').textContent
                };
                window.Telegram.WebApp.sendData(JSON.stringify(cancelData));
                window.Telegram.WebApp.close();
            } else {
                alert('Заказ отменен');
                closeCheckout();
            }
        },
        () => {}
    );
}
function resetSort() {
    // Анимация кнопки
    event.target.classList.add('resetting');
    setTimeout(() => event.target.classList.remove('resetting'), 300);
    
    // Сбрасываем на "По умолчанию"
    appData.sortType = 'default';
    
    // Обновляем UI
    document.querySelectorAll('.sort-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector('.sort-option[data-sort="default"]').classList.add('selected');
    
    // Показываем уведомление
    showNotification('🔄 Сортировка сброшена');
    
    // Применяем
    displayProducts();
}

// Функция сброса фильтров
function resetFilters() {
    // Анимация кнопки
    event.target.classList.add('resetting');
    setTimeout(() => event.target.classList.remove('resetting'), 300);
    
    // Получаем диапазон цен
    const prices = allProducts.map(p => p.price);
    const minPrice = Math.min(...prices);
    const maxPrice = Math.max(...prices);
    
    // Сбрасываем значения
    document.getElementById('priceFrom').value = minPrice;
    document.getElementById('priceTo').value = maxPrice;
    
    appData.priceFilter = {
        from: minPrice,
        to: maxPrice
    };
    
    // Обновляем текст
    updatePriceRangeText();
    
    // Показываем уведомление
    showNotification('🔄 Фильтры сброшены');
    
    // Применяем
    displayProducts();
}

// Обновление текста диапазона цен
function updatePriceRangeText() {
    const from = parseInt(document.getElementById('priceFrom').value) || 0;
    const to = parseInt(document.getElementById('priceTo').value) || 1000;
    const textElement = document.getElementById('priceRangeText');
    
    const prices = allProducts.map(p => p.price);
    const minPrice = Math.min(...prices);
    const maxPrice = Math.max(...prices);
    
    if (from <= minPrice && to >= maxPrice) {
        textElement.textContent = '✅ Показаны все товары';
        textElement.style.color = 'var(--primary)';
    } else {
        const filtered = allProducts.filter(p => p.price >= from && p.price <= to);
        textElement.textContent = `📦 Найдено товаров: ${filtered.length}`;
        textElement.style.color = 'var(--text-dark)';
    }
}

// Добавьте обработчики для обновления текста при изменении
document.getElementById('priceFrom')?.addEventListener('input', updatePriceRangeText);
document.getElementById('priceTo')?.addEventListener('input', updatePriceRangeText);

// Улучшенная функция открытия фильтров
document.getElementById('filterBtn')?.addEventListener('click', function() {
    const prices = allProducts.map(p => p.price);
    const minPrice = Math.min(...prices);
    const maxPrice = Math.max(...prices);
    
    // Устанавливаем placeholder'ы
    document.getElementById('priceFrom').placeholder = minPrice;
    document.getElementById('priceTo').placeholder = maxPrice;
    
    // Если значения не установлены - устанавливаем диапазон
    if (!document.getElementById('priceFrom').value) {
        document.getElementById('priceFrom').value = minPrice;
    }
    if (!document.getElementById('priceTo').value) {
        document.getElementById('priceTo').value = maxPrice;
    }
    
    updatePriceRangeText();
    
    document.getElementById('sortOverlay').classList.add('active');
    document.getElementById('filterSheet').classList.add('active');
});

// Добавьте кнопку "Сбросить все" в хедер каталога (опционально)
function resetAll() {
    resetSort();
    resetFilters();
    appData.currentCategory = 'all';
    
    // Обновляем категории
    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
    document.querySelector('.category-card[data-category="all"]').classList.add('active');
    document.getElementById('currentCategory').textContent = 'Все';
    
    displayProducts();
    showNotification('🔄 Все фильтры сброшены');
}

function closeCheckout() {
    // Если в Telegram - закрываем приложение
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.close();
    } else {
        // Иначе возвращаемся в каталог
        document.getElementById('checkoutContainer').classList.remove('active');
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.querySelector('[data-page="catalog"]').classList.add('active');
        document.getElementById('catalogPage').style.display = 'block';
        document.getElementById('cartPage').classList.remove('active');
    }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    loadAppData();
    const fullNameInput = document.getElementById('fullName');
    const phoneInput = document.getElementById('phone');
    const telegramInput = document.getElementById('telegram');
    const meetTimeInput = document.getElementById('meetTime');
    const contactsNextBtn = document.getElementById('contactsNextBtn');
    
    if (fullNameInput) {
        fullNameInput.addEventListener('input', validateContacts);
    }
    
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value;
            // Автоматически добавляем +375 если его нет
            if (!value.startsWith('+')) {
                value = '+' + value;
            }
            if (!value.startsWith('+375')) {
                value = '+375' + value.replace(/^\+?375?/, '');
            }
            e.target.value = value;
            validateContacts();
        });
    }
    
    if (telegramInput) {
        telegramInput.addEventListener('input', function(e) {
            let value = e.target.value;
            // Автоматически добавляем @
            if (value && !value.startsWith('@')) {
                value = '@' + value;
            }
            e.target.value = value;
            validateContacts();
        });
    }
    
    if (meetTimeInput) {
        meetTimeInput.addEventListener('input', validateContacts);
    }
    
    // Обработчик кнопки "Далее"
    if (contactsNextBtn) {
        contactsNextBtn.addEventListener('click', function() {
            console.log('Next button clicked');
            if (!this.disabled) {
                goToSummary();
            }
        });
    }
    const fields = ['fullName', 'phone', 'telegram', 'meetTime'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', validateContacts);
            field.addEventListener('change', validateContacts);
        }
    });
    loadAppData();
});
if (document.getElementById('fullName')) {
    document.getElementById('fullName').addEventListener('input', validateContacts);
}
if (document.getElementById('phone')) {
    document.getElementById('phone').addEventListener('input', validateContacts);
}
if (document.getElementById('telegram')) {
    document.getElementById('telegram').addEventListener('input', validateContacts);
}
if (document.getElementById('meetTime')) {
    document.getElementById('meetTime').addEventListener('input', validateContacts);
}
window.addEventListener('beforeunload', function(e) {
    if (appData.cart.length > 0) {
        e.preventDefault();
        e.returnValue = 'У вас есть товары в корзине. Вы уверены, что хотите выйти?';
    }
});
window.addEventListener('load', () => {
    const scrollPos = sessionStorage.getItem('scrollPos');
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
    }
});
function goToContactsFix() {
    if (!appData.order.payment) {
        showNotification('⚠️ Выберите способ оплаты');
        return;
    }
    
    // Прямой переход на страницу контактов
    document.getElementById('paymentPage').style.display = 'none';
    document.getElementById('paymentPage').classList.remove('active');
    
    document.getElementById('contactsPage').style.display = 'block';
    document.getElementById('contactsPage').classList.add('active');
    
    // Автозаполнение если есть данные
    if (appData.userData) {
        document.getElementById('fullName').value = appData.userData.fullName || '';
        document.getElementById('phone').value = appData.userData.phone || '';
        document.getElementById('telegram').value = appData.userData.telegram || '';
        validateContacts();
    }
}

window.goToContactsFix = goToContactsFix;
window.addToCart = addToCart;
window.toggleFavorite = toggleFavorite;
window.changeQuantity = changeQuantity;
window.showProductModal = showProductModal;
window.closeProductModal = closeProductModal;
window.toggleCollapsible = toggleCollapsible;
window.addToCartFromModal = addToCartFromModal;
window.startCheckout = startCheckout;
window.openLocationModal = openLocationModal;
window.closeLocationModal = closeLocationModal;
window.selectLocation = selectLocation;
window.confirmAddress = confirmAddress;
window.goToPayment = goToPayment;
window.goToContacts = goToContacts;
window.goToSummary = goToSummary;
window.confirmOrder = confirmOrder;
window.closeCheckout = closeCheckout;
window.renderFavorites = renderFavorites;
window.closeProductModalOnBackground = closeProductModalOnBackground;
window.closeConfirmOnBackground = closeConfirmOnBackground;
window.closeColorSelectorOnBackground = closeColorSelectorOnBackground;
window.changeThemeColor = changeThemeColor;
window.toggleDarkMode = toggleDarkMode;
window.contactSeller = contactSeller;
window.cancelOrder = cancelOrder;
window.openEditData = openEditData;
window.closeEditData = closeEditData;
window.saveEditedData = saveEditedData;
window.goToSummarySimple = goToSummarySimple;
window.resetSort = resetSort;
window.resetFilters = resetFilters;
window.resetAll = resetAll;
window.updatePriceRangeText = updatePriceRangeText;
</script>